<!DOCTYPE html>
<html lang="en">
<head>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#2563eb">
<meta charset="UTF-8">
<title>Trading Journal</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{
  font-family: Arial, sans-serif;
  background:#f4f6f8;
  margin:0;
}
.container{
  max-width:1200px;
  margin:auto;
  padding:20px;
}
.card{
  background:#fff;
  padding:16px;
  border-radius:10px;
  margin-bottom:16px;
  border:1px solid #ddd;
}
h2,h3{margin:0 0 10px}

/* ---------- LAYOUT ---------- */
.trade-layout{
  display:flex;
  gap:20px;
}
.trade-form{
  width:42%;
}

.trade-chart{
  width:58%;
}


/* ---------- INPUTS ---------- */
label{
  font-size:13px;
  color:#555;
  display:block;
  margin-bottom:4px;
}
input{
  padding:6px 8px;
  font-size:13px;
  border-radius:6px;
  border:1px solid #23beaf;
}

.input-row{
  display:flex;
  gap:12px;
  align-items:flex-end;
}
.input-group{
  display:flex;
  flex-direction:column;
}
.date-input{width:160px}
.pnl-input{width:120px}

/* ---------- CHECKBOXES ---------- */
/* ---------- CHECKBOXES (COMPACT PREMIUM) ---------- */
.rules{
  display:grid;
  grid-template-columns:repeat(3, auto);
  gap:6px 8px;
  margin-top:6px;
}

.rules label{
  display:flex;
  align-items:center;
  gap:6px;
  font-size:12px;
  background:#f9fafb;
  padding:4px 8px;          /* ‚¨Ö reduced padding */
  border-radius:6px;
  border:1px solid #23beaf;
  cursor:pointer;
  line-height:1.2;
}

.rules input{
  width:12px;               /* ‚¨Ö smaller checkbox */
  height:12px;
  margin:0;
}

.rules label:hover{
  background:#f1f5f9;
}
/* ---------- BUTTONS ---------- */
button{
  padding:7px 14px;
  border:none;
  border-radius:6px;
  cursor:pointer;
  font-size:13px;
}
.save{background:#2563eb;color:#fff}
.export{background:#374151;color:#fff;margin-left:8px}

/* ---------- SUMMARY ---------- */
.summary{
  display:flex;
  gap:20px;
  flex-wrap:wrap;
}
.summary span{
  font-size:16px;
  font-weight:bold;
}

/* ---------- CALENDAR ---------- */
.calendar{
  display:grid;
  grid-template-columns:repeat(7,1fr);
  gap:8px;
}
.day-header{
  text-align:center;
  font-size:12px;
  color:#666;
}
.day{
  min-height:68px;
  padding:6px;
  border-radius:6px;
  font-size:12px;
  cursor:pointer;
  border:1px solid #23beaf;
}
.green{background:#e6f7ec;color:#166534}
.red{background:#fdecec;color:#991b1b}
.neutral{background:#f1f5f9;color:#555}

/* ---- Calendar UI polish ---- */
.day{
  position: relative; /* required for positioning */
  transition: transform 0.1s ease, box-shadow 0.1s ease;
}
.day:active{
  transform: scale(0.97);
}
.day:hover{
  filter: brightness(0.97);
}

/* Date top-right (quiet, not bold) */
.day-date{
  position: absolute;
  top: 6px;
  right: 6px;
  font-size: 13px;
  font-weight: normal;
  opacity: 0.75;
}

/* PnL hero (left aligned) */
.day-pnl{
  margin-top: 20px;
  font-size: 16px;      /* slightly bigger */
  font-weight: bold;   /* bold */
}

/* Bottom-right details */
.day-details{
  position: absolute;
  right: 6px;
  bottom: 6px;
  text-align: right;
  font-size: 12px;
  line-height: 1.4;
  opacity: 0.8;
}


/* ---------- TABLE ---------- */
.hidden{display:none}
table{
  width:100%;
  border-collapse:collapse;
}
th,td{
  border-bottom:1px solid #ddd;
  padding:8px;
  font-size:13px;
  text-align:left;
}

.pnl-col{width:120px;font-weight:bold}

/* ---------- PIE ---------- */
.trade-chart h3{
  font-size:15px;
  color:#374151;
  margin-bottom:8px;
}

/* ---- PIE SIZE CONTROL ---- */
.pie-wrapper{
  width:100%;
  max-width:260px;        /* controls width */
  height:260px;           /* controls height */
  margin:auto;
}

.trade-chart canvas{
  width:100% !important;
  height:100% !important;
}

  .calendar-day {
  border-radius: 10px;
  padding: 10px;
  min-height: 95px;
  font-size: 13px;
}

.calendar-day.profit {
  background: #e9f9ee; /* green */
}

.calendar-day.loss {
  background: #fdecec; /* red */
}

.calendar-pnl.profit {
  color: #15803d;
  font-weight: bold;
}

.calendar-pnl.loss {
  color: #b91c1c;
  font-weight: bold;
}

.calendar-meta {
  margin-top: 2px;
}

.calendar-wl {
  margin-top: 6px;
  font-weight: bold;
  font-size: 12px;
}
/* ---- Summary UI ---- */
.summary-cards{
  display:flex;
  gap:16px;
  flex-wrap:wrap;
}

.summary-box{
  flex:1;
  background: #f1f5f9;
  border:1px solid #23beaf;
  border-radius:10px;
  padding:16px;
}

.summary-label{
  font-size:12px;
  text-transform:uppercase;
  color:#6b7280;
  margin-bottom:6px;
}

.summary-value{
  font-size:24px;
  font-weight:bold;
  line-height:1.2;
}

/* Color accents */
.profit-box .summary-value{ color:#16a34a; }
.loss-box .summary-value{ color:#dc2626; }
.net-box .summary-value{ color:#16a34a; }

/* ---- Drill-down table (final) ---- */

/* PnL */
.pnl{
  font-weight:bold;
}
.pnl.profit{
  color:#16a34a;
}
.pnl.loss{
  color:#dc2626;
}

/* Mistake tag */
.mistake{
  display:inline-block;
  padding:4px 10px;
  font-size:12px;
  border-radius:999px;
  background:#f1f5f9;
  color:#374151;
  border:1px solid #23beaf;
}

/* Mistake on loss */
.mistake.loss{
  background:#fee2e2;
  color:#b91c1c;
  border-color:#fecaca;
}
.mistake-card.bad:hover{
  background:#fee2e2;        /* light red */
  border-color:#fecaca;
  color:#991b1b;
}

/* GOOD / DISCIPLINED ‚Üí GREEN hover */
.mistake-card.good:hover{
  background:#dcfce7;        /* light green */
  border-color:#bbf7d0;
  color:#166534;
}
/* ---------- MISTAKE HEATMAP ---------- */
.heatmap{
  display:flex;
  align-items:flex-end;
  gap:18px;
  height:220px;              /* REQUIRED */
  padding-bottom:6px;
}

.bar-col{
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:flex-end;
  height:100%;
}

.bar{
  width:34px;
  border-radius:6px 6px 0 0;
}

/* Red intensity */
.bar.high{ background:#b91c1c; }
.bar.medium{ background:#dc2626; }
.bar.low{ background:#f87171; }

.bar-value{
  margin-top:6px;
  font-size:12px;
  font-weight:bold;
  color:#991b1b;
}

.bar-label{
  font-size:11px;
  color:#374151;
  text-align:center;
  white-space:nowrap;
}

  /* ---------- CHECKBOXES (COMPACT PREMIUM ‚Äì FINAL) ---------- */
.rules{
  display:grid;
  grid-template-columns:repeat(3, auto); /* dense grid */
  gap:6px 8px;
  margin-top:6px;
}

.rules label{
  display:flex;
  align-items:center;
  gap:6px;
  font-size:12px;
  background:#f9fafb;
  padding:4px 8px;          
  border-radius:6px;
  border:1px solid #23beaf;
  cursor:pointer;
  line-height:1.2;

  white-space:nowrap;       
  max-width:fit-content;    
}

.rules input{
  width:12px;              
  height:12px;
  margin:0;
}

.rules label:hover{
  background:#f1f5f9;
}

/* ===== MONTHLY PERFORMANCE (PURE CSS BARS) ===== */

.monthly-grid{
  display:flex;
  gap:5px;
  align-items:flex-end;
  min-height:260px;  
}

/* One month column */
.month{
  width:120px;
  text-align:center;
}

/* Bars container */
.bar-area{
  height:220px;
  display:flex;
  align-items:flex-end;
  justify-content:center;
  gap:10px;
}

/* IMPORTANT: enables % height bars */
.bar-wrap{
  height:100%;
  display:flex;
  flex-direction:column;
  justify-content:flex-end;
}

/* Bars */
.bar{
  width:20px;
  border-radius:6px 6px 0 0;
}

.bar.profit{ background:#16a34a; }  /* green */
.bar.loss{ background:#dc2626; }    /* red */

/* Values above bars */
.bar-value{
  font-size:12px;
  margin-bottom:6px;
  color:#111827;
}

/* Month text */
.month-label{
  margin-top:10px;
  font-size:13px;
  color:#374151;
}

.trade-count{
  font-size:12px;
  color:#6b7280;
  margin-top:px;
}

/* Net P&L (calendar-style emphasis) */
.net{
  margin-top:6px;
  font-size:16px;
  font-weight:bold;
}

.net.profit{ color:#16a34a; }
.net.loss{ color:#dc2626; }

.bar-col {
  position: relative;
  margin: 0 8px;   /* üëà creates space between bar groups */
}

.bar-value {
  margin-bottom: 6px;
  font-size: 12px;
  font-weight: 600;
  text-align: center;
  white-space: nowrap;
}

/* ===== Bar animation (Monthly / Heatmap / Any bars) ===== */
@keyframes growUp {
  from {
    transform: scaleY(0);
    opacity: 0;
  }
  to {
    transform: scaleY(1);
    opacity: 1;
  }
}

.bar {
  transform-origin: bottom;
  animation: growUp 0.6s ease-out forwards;
}

.bar {
  transition: transform 0.15s ease, filter 0.15s ease;
}

.bar:hover {
  transform: translateY(-4px);
  filter: brightness(1.05);
}

.calendar-header{
  justify-content:center;
  align-items:center;
  gap:16px;
  margin-bottom:12px;
}

.calendar-header button{
  border:none;
  background:#f1f5f9;
  border-radius:6px;
  padding:4px 10px;
  cursor:pointer;
  font-size:14px;
}

.calendar-header span{
  font-weight:bold;
  font-size:14px;
}

/* ---------- SELECT (Instrument Dropdown) ---------- */
.select-input {
  appearance: none;                 /* remove default arrow */
  -webkit-appearance: none;
  -moz-appearance: none;
  padding: 6px 34px 6px 10px;        /* space for arrow */
  font-size: 12px;
  border-radius: 6px;
  border: 1px solid #23beaf;
  background-color: #fff;
  color: #111827;
  height: 30px;                     /* MATCH input height */
  width: 160px;
  background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 20 20' fill='gray' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M5.5 7.5l4.5 4.5 4.5-4.5'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 10px center;
  background-size: 14px;
}
/* Hover & focus polish */
.select-input:hover {
  background-color: #f9fafb;
}
.select-input:focus {
  outline: none;
  border-color: #2563eb;
  box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.3);
}
/* Header row */
.card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  cursor: pointer;
}
/* Chevron animation */
.chevron {
  font-size: 18px;
  transition: transform 0.2s ease;
}
/* Body collapse animation */
.card-body {
  overflow: hidden;
  transition: max-height 0.25s ease, opacity 0.2s ease;
}
/* Collapsed state */
.collapsible.collapsed .card-body {
  max-height: 0;
  opacity: 0;
}
/* Rotate arrow */
.collapsible.collapsed .chevron {
  transform: rotate(-90deg);
}
  .instrument-card {
  flex: 1;
  background: #f1f5f9;
  border: 1px solid #23beaf;
  border-radius: 12px;
  padding: 16px;
}
.instrument-name {
  font-size: 13px;
  text-transform: uppercase;
  color: #6b7280;
  margin-bottom: 6px;
}
.instrument-pnl {
  font-size: 22px;
  font-weight: bold;
}
.instrument-pnl.profit {
  color: #16a34a;
}
.instrument-pnl.loss {
  color: #dc2626;
}
.instrument-trades {
  font-size: 13px;
  color: #374151;
  margin-top: 6px;
}
.instrument-wl {
  font-size: 12px;
  margin-top: 4px;
  color: #6b7280;
}
  /* ===== Make Instrument card single-line ===== */
.instrument-card {
  display: flex;
  align-items: center;
  gap: 14px;
}
.instrument-card > div {
  margin: 0 !important;
}
/* Net PnL bigger */
.instrument-pnl {
  font-weight: bold;
  font-size: 18px;
}
/* Small meta text */
.instrument-trades,
.instrument-wl {
  font-size: 12px;
  color: #6b7280;
}
/* Optional separator look */
.instrument-trades::before,
.instrument-wl::before {
  content: "‚Ä¢";
  margin-right: 6px;
}
.instrument-wl .win {
  color: #16a34a; /* green */
  font-weight: 600;
}
.instrument-wl .loss {
  color: #dc2626; /* red */
  font-weight: 600;
}
/* Monthly Performance ‚Äì bar value color sync */
.month .bar-wrap .bar-value {
  font-weight: 600;
  margin-bottom: 6px;
}
/* Profit bar ‚Üí green value */
.month .bar-wrap .bar.profit + .bar-value,
.month .bar-wrap .bar-value:has(+ .bar.profit) {
  color: #16a34a;
}
/* Loss bar ‚Üí red value */
.month .bar-wrap .bar.loss + .bar-value,
.month .bar-wrap .bar-value:has(+ .bar.loss) {
  color: #dc2626;
}

/* ---- existing CSS (all your current styles) ---- */
/* ===========================
   GLOBAL VISUAL POLISH
   =========================== */
.summary-value,
.net {
  font-size: 18px;
  letter-spacing: 0.2px;
}
.trade-count,
.instrument-trades {
  font-size: 12px;
  opacity: 0.7;
}
/* Better numeric alignment */
.summary-value,
.bar-value,
.instrument-pnl,
.net {
  font-variant-numeric: tabular-nums;
}
/* ===========================
   CARD DEPTH & BACKGROUND
   =========================== */
.card {
  background: linear-gradient(180deg, #e7dddd 0%, #cfe0cf 100%);
  border: 1px solid #23beaf;
  box-shadow: 0 1px 2px rgba(0,0,0,0.04);
}
/* ===========================
   COLLAPSIBLE HEADER POLISH
   =========================== */
.card-header {
  transition: background 0.2s ease;
}
.chevron {
  transition: transform 0.25s ease;
}
.collapsed .chevron {
  transform: rotate(-90deg);
}
/* ===========================
   SUMMARY CARD ‚Äì STRONG BOUNCE
   =========================== */
.summary-box {
  transition:
    transform 0.22s cubic-bezier(0.34, 1.56, 0.64, 1),
    box-shadow 0.22s ease;
}
.summary-box:hover {
  transform: translateY(-5px) scale(1.02);
  box-shadow: 0 14px 28px rgba(0,0,0,0.12);
}
.summary-box:active {
  transform: scale(0.97);
}
/* ===========================
   INSTRUMENT CARD ‚Äì SOFT HOVER
   =========================== */
.instrument-card {
  transition: transform 0.15s ease, box-shadow 0.15s ease;
}
.instrument-card:hover {
 transform: translateY(-5px) scale(1.02);
  box-shadow: 0 14px 28px rgba(0,0,0,0.12);
}
/* ===========================
   PROFIT / LOSS COLOR LANGUAGE
   =========================== */
.profit {
  color: #16a34a;
}
.loss {
  color: #dc2626;
}
/* ===========================
   MONTHLY BAR ‚Äì STRONG BOUNCE
   =========================== */
.bar {
  transform-origin: bottom;
  animation: barBounce 0.55s cubic-bezier(0.34, 1.56, 0.64, 1);
}
/* Monthly bar hover (optional but nice) */
.bar:hover {
  filter: brightness(1.08);
}
/* Bar value emphasis */
.bar-value {
  font-weight: 600;
  margin-bottom: 6px;
}
/* ===========================
   MONTHLY BAR VALUE COLOR SYNC
   =========================== */
/* Profit bar value ‚Üí green */
.month .bar-wrap .bar-value:has(+ .bar.profit) {
  color: #16a34a;
}
/* Loss bar value ‚Üí red */
.month .bar-wrap .bar-value:has(+ .bar.loss) {
  color: #dc2626;
}
/* ===========================
   ANIMATIONS
   =========================== */
@keyframes barBounce {
  0%   { transform: scaleY(0); }
  60%  { transform: scaleY(1.05); }
  100% { transform: scaleY(1); }
}

/* ===========================
   MONTHLY BAR ‚Äì STRONG HOVER BOUNCE
   =========================== */
.month .bar {
  transition:
    transform 0.18s cubic-bezier(0.34, 1.56, 0.64, 1),
    filter 0.18s ease;
  transform-origin: bottom;
}

/* HOVER BOUNCE */
.month:hover .bar {
  transform: scaleY(1.15);
}

/* INDIVIDUAL BAR HOVER (even stronger) */
.month .bar:hover {
  transform: scaleY(1.2);
}
.tax-box .summary-value {
  color: #b45309;   /* amber */
}

/* ===========================
   FORCE MISTAKE CARDS LAYOUT
=========================== */

#mistakeStats {
  display: flex !important;
  gap: 16px !important;
  flex-wrap: wrap !important;
}

#mistakeStats .mistake-card {
  min-width: 180px;
  padding: 16px;
  border-radius: 14px;
  background: #e7dddd ;
  border: 1px solid #23beaf;
  box-shadow: 0 2px 8px rgba(0,0,0,0.05);
  transition: transform 0.22s cubic-bezier(0.34, 1.56, 0.64, 1),
              box-shadow 0.22s ease;
}

#mistakeStats .mistake-card:hover {
  transform: translateY(-6px) scale(1.03);
  box-shadow: 0 14px 28px rgba(0,0,0,0.12);
}

#mistakeStats .mistake-title {
  font-size: 14px;
  color: #6b7280;
  margin-bottom: 8px;
}

#mistakeStats .mistake-amount {
  font-size: 18px;
  font-weight: 700;
  color: #dc2626;
  margin-bottom: 6px;
  font-variant-numeric: tabular-nums;
}

#mistakeStats .mistake-trades {
  font-size: 13px;
  color: #9ca3af;
}

.streak-badge{
  position:absolute;
  top:56px;
  left:4px;
  background:#1350d5;
  color:#fff;
  font-size:10px;
  padding:2px 6px;
  border-radius:20px;
  font-weight:600;
}
.calendar-summary {
  text-align: center;
  font-size: 15px;
  font-weight: 500;
  margin-bottom: 25px;
  color: #374151;
}
.calendar-summary strong {
  font-weight: 700;
}
.calendar-summary.profit {
  color: #16a34a;
}
.calendar-summary.loss {
  color: #dc2626;
}
.calendar-header{
  position: absolute;
  top: 16px;
  right: 20px;
  display: flex;
  align-items: center;
  gap: 8px;
}
.card h3 + .calendar-header,
.card .calendar-header{
  position: absolute;
}
.card{
  position: relative;
}

/* ===== DARK BACKGROUND ===== */
/* Particle canvas */
#particles-bg {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  z-index: -1;
  background: #0f2051;
}
.container {
  position: relative;
  z-index: 1;
}

/* ===== BROKERAGE ACCORDION ===== */

.brokerage-month {
  border: 1px solid #23beaf;
  border-radius: 12px;
  margin-bottom: 14px;
  background: #f1f5f9;
  overflow: hidden;
  transition: all 0.25s ease;
}

.brokerage-header {
  padding: 14px 16px;
  cursor: pointer;
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-weight: 600;
  transition: background 0.2s ease;
}

.brokerage-header:hover {
  background: #e2e8f0;
}

.brokerage-total {
  font-weight: 700;
  color: #dc2626;
}

.brokerage-count {
  font-size: 12px;
  color: #6b7280;
  margin-left: 8px;
}

.brokerage-body {
  max-height: 0;
  overflow: hidden;
  transition: max-height 0.35s ease, opacity 0.25s ease;
  opacity: 0;
  background: #ffffff;
}

.brokerage-month.active .brokerage-body {
  max-height: 500px;
  opacity: 1;
}

.brokerage-row {
  display: flex;
  justify-content: space-between;
  padding: 10px 16px;
  font-size: 13px;
  border-top: 1px solid #e5e7eb;
}

.brokerage-row:hover {
  background: #f9fafb;
}

.brokerage-amount {
  color: #dc2626;
  font-weight: 600;
}
  
</style>
</head>
  
<body>
<canvas id="particles-bg"></canvas>
<div class="container">
<!-- ADD TRADE + PIE -->
<div class="card">
<h3>üìù Add Trade</h3>

<div class="trade-layout">
  <!-- LEFT 50% -->
  <div class="trade-form">
    <div class="input-row">
      <div class="input-group">
        <label>Date</label>
        <input type="date" id="date" class="date-input">
      </div>
      <div class="input-group">
        <label>PnL</label>
        <input type="number" id="pnl" class="pnl-input" placeholder="+ / -">
      </div>
    </div>

 <div class="input-group">
  <label>Instrument</label>
  <select id="instrument" class="select-input">
    <option value="NIFTY">NIFTY</option>
    <option value="SENSEX">SENSEX</option>
    <option value="BROKERAGE">BROKERAGE</option>
  </select>
</div>
   <label style="margin-top:10px">Mistakes</label>
   <div class="rules"> <label class="mistake-card bad">   <input type="checkbox" value="No Stop Loss"> No SL </label> 
   <label class="mistake-card bad">   <input type="checkbox" value="Free Channel with SL"> Free SL </label>
   <label class="mistake-card bad">  <input type="checkbox" value="FOMO Entry"> FOMO </label>
   <label class="mistake-card bad">   <input type="checkbox" value="Target 2 with SL"> T2 SL </label>
   <label class="mistake-card good"> <input type="checkbox" value="Target 1 Hit"> T1 Hit </label>
   <label class="mistake-card good"> <input type="checkbox" value="Free Channel Target Hit"> Free T1 </label>
   <label class="mistake-card bad"> <input type="checkbox" value="Stop Loss Hit"> SL Hit </label>
   <label class="mistake-card neutral"> <input type="checkbox" value="BROKERAGE"> Brokerage </label>
    </div>

    <div style="margin-top:12px">
      <button class="save" onclick="saveTrade()">Save</button>
      <button class="export" onclick="exportCSV()">Export</button>
    </div>
  </div>
  <!-- RIGHT 50% -->
  <div class="trade-chart">
  <div style="display:flex; gap:24px; align-items:flex-end">
    <!-- PIE -->
    <div>
      <h3>Profit & Loss</h3>
      <div class="pie-wrapper">
        <canvas id="lossPie"></canvas>
      </div>
    </div>
    <!-- HEATMAP -->
    <div>
      <h3>Mistake Impact</h3>
      <div class="heatmap" id="mistakeHeatmap"></div>
    </div>
  </div>
</div>
</div>
</div>

<!-- SUMMARY -->
<div class="card collapsible">
  <div class="card-header" onclick="toggleSection(this)">
    <h3>üßæ Summary</h3>
    <span class="chevron">‚ñæ</span>
  </div>
  <div class="card-body">
    <div class="summary-cards">
      <div class="summary-box profit-box">
        <div class="summary-label">Total Profit</div>
        <div class="summary-value" id="profit">‚Çπ0</div>
      </div>
      <div class="summary-box loss-box">
        <div class="summary-label">Total Loss</div>
        <div class="summary-value" id="loss">‚Çπ0</div>
      </div>
      <div class="summary-box tax-box" onclick="openTaxesDrill()">
  	    <div class="summary-label">Taxes / Brokerage</div>
  	    <div class="summary-value" id="taxes">‚Çπ0</div>
      </div>
      <div class="summary-box net-box">
        <div class="summary-label">Net P&amp;L</div>
        <div class="summary-value" id="net">‚Çπ0</div>
      </div>
      <div class="summary-box">
        <div class="summary-label">Gross Expectancy</div>
        <div class="summary-value" id="grossExpectancy">‚Çπ0</div>
      </div>
      <div class="summary-box">
        <div class="summary-label">Net Expectancy</div>
        <div class="summary-value" id="netExpectancy">‚Çπ0</div>
      </div>
    </div>
  </div>
</div>

<div class="card collapsible collapsed">
  <div class="card-header" onclick="toggleSection(this)">
    <h3>üìÜ Weekday Success Rate</h3>
    <span class="chevron">‚ñæ</span>
  </div>
  <div class="card-body">
    <div id="weekdayStats" style="display:flex; gap:12px; flex-wrap:wrap;"></div>
  </div>
</div>

<!-- Mistake Analysis -->
<!-- MISTAKE ANALYSIS -->
<div class="card collapsible collapsed">
  <div class="card-header" onclick="toggleSection(this)">
    <h3>üö® Mistake Cost Analysis</h3>
    <span class="chevron">‚ñæ</span>
  </div>
  <div class="card-body">
    <div id="mistakeStats" class="mistake-grid"></div>
  </div>
</div>
<template id="mistakeTemplate">
  <div class="mistake-card">
    <div class="mistake-title"></div>
    <div class="mistake-amount"></div>
    <div class="mistake-trades"></div>
  </div>
</template>
  
<!-- MONTHLY PERFORMANCE -->
<div class="card collapsible collapsed">
  <div class="card-header" onclick="toggleSection(this)">
    <h3>üìä Monthly Performance</h3>
    <span class="chevron">‚ñæ</span>
  </div>
  <div class="card-body">
    <div id="monthlyGrid" class="monthly-grid"></div>
  </div>
</div>

<div class="card collapsible collapsed">
  <div class="card-header" onclick="toggleSection(this)">
    <h3>üìà Instrument Performance</h3>
    <span class="chevron">‚ñæ</span>
  </div>
  <div class="card-body">
    <div id="instrumentStats" style="display:flex; gap:24px;"></div>
  </div>
</div>

<!-- CALENDAR -->
<div class="card">
<h3>üìÖ Calendar</h3>
<div id="calendarSummary" class="calendar-summary"></div>
<div class="calendar-header">
  <button onclick="changeMonth(-1)">‚óÄ</button>
  <span id="calendarTitle"></span>
  <button onclick="changeMonth(1)">‚ñ∂</button>
</div>
<div class="calendar" id="calendar"></div>
</div>

<!-- DRILL -->
<div class="card hidden" id="drill">
<h3 id="drillTitle"></h3>
<table>
<thead>
<tr><th class="pnl-col">PnL</th><th>Mistakes</th></tr>
</thead>
<tbody id="drillBody"></tbody>
</table>
</div>

<!-- PREMIUM BROKERAGE ACCORDION -->
<div class="card hidden" id="taxDrill">
  <div class="card-header">
    <h3>üí∏ Brokerage Breakdown</h3>
  </div>
  <div class="card-body">
    <div id="brokerageAccordion"></div>
  </div>
</div>
  
</div>
<script>

let currentMonth = new Date().getMonth();
let currentYear  = new Date().getFullYear();
let db, lossChart;
const mistakeColorMap = {
  "No Stop Loss": "#dc2626",
  "Target 2 with SL": "#b91c1c",
  "FOMO Entry": "#f59e0b",
  "Free Channel with SL": "#fb923c",
  "Free Channel Target Hit": "#ea580c",
  "Stop Loss Hit": "#60a5fa",
  "Target 1 Hit": "#22c55e"
};

/* DB */
const req=indexedDB.open("TradeJournalDB",1);
req.onupgradeneeded=e=>{
  e.target.result.createObjectStore("trades",{keyPath:"id",autoIncrement:true});
};
req.onsuccess=e=>{
  db=e.target.result;
  loadAll();
};

/* SAVE */
function saveTrade() {
  const dateValue = document.getElementById("date").value;
  const pnlValue  = Number(document.getElementById("pnl").value);
  const instrumentValue = document.getElementById("instrument").value;

  if (!dateValue || pnlValue === 0) {
    alert("Date & PnL required");
    return;
  }
  const ruleNodes = document.querySelectorAll(".rules input[type=checkbox]");
  const rules = [];
  ruleNodes.forEach(cb => {
    if (cb.checked) {
      rules.push(cb.value);
    }
  });

const isBrokerage = rules.includes("BROKERAGE");
  const trade = {
    date: dateValue,
    pnl: pnlValue,
    rules: rules,
   isBrokerage,
   instrument: instrumentValue 
  };

  const tx = db.transaction("trades", "readwrite");
  tx.objectStore("trades").add(trade);
  tx.oncomplete = () => {
    clearForm();
    loadAll();
  };
}

/* LOAD */
function loadAll(){
  db.transaction("trades","readonly")
    .objectStore("trades")
    .getAll()
    .onsuccess = e => {
      const trades = e.target.result;   
      updateSummary(trades);
      buildMonthlyPerformance(trades);
      buildCalendar(trades);
      buildLossPie(trades);
      buildMistakeHeatmap(trades);
      buildMistakeAnalysis(trades);
      buildInstrumentPerformance(trades);
      buildWeekdaySuccessRate(trades);
    };
}

/* SUMMARY */
function updateSummary(trades){

  let profit = 0;
  let loss = 0;
  let taxes = 0;
  let tradeCount = 0;

  trades.forEach(t => {

    if (t.isBrokerage) {
      taxes += Math.abs(t.pnl);
      return;
    }

    tradeCount++;

    if (t.pnl > 0) profit += t.pnl;
    if (t.pnl < 0) loss += Math.abs(t.pnl);
  });

  const grossNet = profit - loss;
  const finalNet = grossNet - taxes;

  // ---- EXISTING VALUES ----
  document.getElementById("profit").innerText = "‚Çπ" + profit.toLocaleString();
  document.getElementById("loss").innerText = "‚Çπ" + loss.toLocaleString();
  document.getElementById("taxes").innerText = "‚Çπ" + taxes.toLocaleString();

  document.getElementById("net").innerText =
    (finalNet >= 0 ? "‚Çπ" : "-‚Çπ") + Math.abs(finalNet).toLocaleString();

  document.getElementById("net").style.color =
    finalNet >= 0 ? "#16a34a" : "#dc2626";

  // ---- EXPECTANCY ----
  const grossExpectancy =
    tradeCount === 0 ? 0 : grossNet / tradeCount;

  const netExpectancy =
    tradeCount === 0 ? 0 : finalNet / tradeCount;

  const grossEl = document.getElementById("grossExpectancy");
  const netEl   = document.getElementById("netExpectancy");

  grossEl.innerText =
    (grossExpectancy >= 0 ? "‚Çπ" : "-‚Çπ") +
    Math.abs(Math.round(grossExpectancy)).toLocaleString() +
    " / trade";

  netEl.innerText =
    (netExpectancy >= 0 ? "‚Çπ" : "-‚Çπ") +
    Math.abs(Math.round(netExpectancy)).toLocaleString() +
    " / trade";

  grossEl.style.color =
    grossExpectancy >= 0 ? "#16a34a" : "#dc2626";

  netEl.style.color =
    netExpectancy >= 0 ? "#16a34a" : "#dc2626";
}

    
/* CALENDAR */

function buildCalendar(t){

 calendar.innerHTML = "";
const streakMap = calculateWinningStreaks(t);

 const y = currentYear;
 const m = currentMonth;

document.getElementById("calendarTitle").innerText =
  new Date(y, m).toLocaleString("default", {
    month: "long",
    year: "numeric"
  });	

  const first = new Date(y, m, 1).getDay() || 7;
  const days  = new Date(y, m + 1, 0).getDate();
  const map = {};

  t.forEach(x => {
    map[x.date] = (map[x.date] || []).concat(x);
  });

  /* ============================
     üî• PROFITABLE DAYS SUMMARY
     ============================ */

  let profitableDays = 0;
  let tradedDays = 0;

  Object.entries(map).forEach(([date, list]) => {

    const d = new Date(date);
    if (d.getFullYear() !== y || d.getMonth() !== m) return;

    let dailyNet = 0;
    let hasTrade = false;

    list.forEach(x => {
      if (!x.isBrokerage) {
        dailyNet += x.pnl;
        hasTrade = true;
      }
    });

    if (hasTrade) {
      tradedDays++;
      if (dailyNet > 0) profitableDays++;
    }
  });

  const summaryEl = document.getElementById("calendarSummary");

  if (summaryEl) {
    if (tradedDays === 0) {
      summaryEl.innerHTML = "";
    } else {
      const percent = Math.round((profitableDays / tradedDays) * 100);

      summaryEl.className = "calendar-summary " +
        (profitableDays >= tradedDays / 2 ? "profit" : "loss");

      summaryEl.innerHTML = `
        üî• You are Profitable for 
        <strong>${profitableDays} / ${tradedDays}</strong> 
        Traded Days (${percent}%)
      `;
    }
  }

  /* ============================
     CALENDAR RENDERING
     ============================ */

  ["Mon","Tue","Wed","Thu","Fri","Sat","Sun"]
    .forEach(h => calendar.innerHTML += `<div class="day-header">${h}</div>`);

  for (let i = 1; i < first; i++) {
    calendar.innerHTML += `<div></div>`;
  }

  for (let i = 1; i <= days; i++) {

    const ds = `${y}-${String(m+1).padStart(2,"0")}-${String(i).padStart(2,"0")}`;
    const list = map[ds] || [];

    if (list.length === 0) {
      calendar.innerHTML += `
        <div class="day neutral">
          <div class="day-date">${i}</div>
          No Trades
        </div>`;
      continue;
    }

    let pnl = 0, wins = 0, losses = 0;

    list.forEach(x => {
      if (x.isBrokerage) return;
      pnl += x.pnl;
      if (x.pnl > 0) wins++;
      if (x.pnl < 0) losses++;
    });

    const colorClass = pnl >= 0 ? "green" : "red";

    calendar.innerHTML += `
      <div class="day ${colorClass}" onclick="openDay('${ds}')">
        ${streakMap[ds] ? `<div class="streak-badge">üî•${streakMap[ds]}</div>` : ""}
        <div class="day-date">${i}</div>
        <div class="day-pnl">‚Çπ${pnl}</div>
        <div class="day-details">
          ${list.filter(t => !t.isBrokerage).length} trades<br>
          ${wins}W / ${losses}L
        </div>
      </div>`;
  }
}


function buildMonthlyPerformance(trades){
  const grid = document.getElementById("monthlyGrid");
  if (!grid) {
    console.warn("‚ùå monthlyGrid not found");
    return;
  }
  if (!Array.isArray(trades) || trades.length === 0) {
    console.warn("‚ùå No trades for monthly chart");
    grid.innerHTML = "<div style='color:#6b7280'>No data</div>";
    return;
  }
  grid.innerHTML = "";
  const monthMap = {};
  trades.forEach(t => {
    if (!t.date || typeof t.pnl !== "number") return;
    const d = new Date(t.date);
    const key = `${d.getFullYear()}-${d.getMonth()}`;
    
  if (!monthMap[key]) {
  monthMap[key] = {
    label: d.toLocaleString("default",{month:"short",year:"numeric"}),
    trades: 0,
    profit: 0,
    loss: 0,
    taxes: 0   // üî• new
  };
}

// Brokerage ‚Üí taxes only
if (t.isBrokerage) {
  monthMap[key].taxes += Math.abs(t.pnl);
  return;
}

// Normal trades
monthMap[key].trades++;

if (t.pnl > 0) monthMap[key].profit += t.pnl;
if (t.pnl < 0) monthMap[key].loss += Math.abs(t.pnl);
   
    
  });
  const months = Object.values(monthMap);
  if (!months.length) {
    grid.innerHTML = "<div style='color:#6b7280'>No monthly data</div>";
    return;
  }

  const maxValue = Math.max(
    ...months.map(m => Math.max(m.profit, m.loss, 1))
  );

  months.forEach(m => {
    const net = m.profit - m.loss;

    const profitHeight = (m.profit / maxValue) * 100;
    const lossHeight   = (m.loss / maxValue) * 100;

    grid.innerHTML += `
      <div class="month">
        <div class="bar-area">
          <div class="bar-wrap">
            ${m.profit ? `<div class="bar-value">‚Çπ${m.profit.toLocaleString()}</div>` : ``}
            <div class="bar profit" style="height:${profitHeight}%"></div>
          </div>
          <div class="bar-wrap">
            ${m.loss ? `<div class="bar-value">‚Çπ${m.loss.toLocaleString()}</div>` : ``}
            <div class="bar loss" style="height:${lossHeight}%"></div>
          </div>
        </div>
        <div class="month-label">${m.label}</div>
        <div class="trade-count">${m.trades} trades</div>
        <div class="net ${net >= 0 ? "profit" : "loss"}">
          ${net >= 0 ? "‚Çπ" : "-‚Çπ"}${Math.abs(net).toLocaleString()}
        </div>
      </div>
    `;
  });

  console.log("‚úÖ Monthly chart rendered");
}


/* DRILL */
function openDay(selectedDate) {

  const drill = document.getElementById("drill");
  const drillTitle = document.getElementById("drillTitle");
  const drillBody = document.getElementById("drillBody");

  drill.classList.remove("hidden");
  drillTitle.innerText = "Trades on " + selectedDate;
  drillBody.innerHTML = "";

  const tx = db.transaction("trades", "readonly");
  const store = tx.objectStore("trades");
  const req = store.getAll();

  req.onsuccess = () => {

    const filtered = req.result
      .filter(t => t.date === selectedDate)
      .filter(t => !t.isBrokerage);   // üî• remove brokerage here

    if (!filtered.length) {
      drillBody.innerHTML = `
        <tr>
          <td colspan="2" style="color:#6b7280;padding:12px;">
            No Trading Entries
          </td>
        </tr>`;
      return;
    }

    filtered.forEach(t => {

      drillBody.innerHTML += `
        <tr>
          <td class="pnl-col pnl ${t.pnl < 0 ? 'loss' : 'profit'}">
            ${t.pnl >= 0 ? "‚Çπ" + t.pnl : "-‚Çπ" + Math.abs(t.pnl)}
          </td>

          <td>
            ${
              Array.isArray(t.rules) && t.rules.length
                ? `<span class="mistake ${t.pnl < 0 ? 'loss' : ''}">
                     ${t.rules.join(", ")}
                   </span>`
                : "-"
            }
          </td>
        </tr>
      `;
    });
  };
}

/* PIE */
function buildLossPie(trades) {
  const impactByMistake = {};
  trades.forEach(t => {
    if (t.isBrokerage) return;
    if (!t.rules || t.rules.length === 0) return;
    const impact = Math.abs(t.pnl); // profit + loss
    t.rules.forEach(rule => {
      impactByMistake[rule] =
        (impactByMistake[rule] || 0) + impact;
    });
  });

  // Destroy old chart (CRITICAL)
  if (window.lossChart) {
    window.lossChart.destroy();
    window.lossChart = null;
  }
  const labels = Object.keys(impactByMistake);
  const data = Object.values(impactByMistake);
  if (labels.length === 0) return;
  
  const colorMap = {
  "No Stop Loss": "#dc2626",            
  "Target 2 with SL": "#b91c1c",        
  "FOMO Entry": "#f59e0b",              
  "Free Channel with SL": "#fb923c",    
  "Free Channel Target Hit": "#ea580c", 
  "Stop Loss Hit": "#60a5fa",           
  "Target 1 Hit": "#22c55e"             
  };
  const colors = labels.map(l => colorMap[l] || "#94a3b8");
  const ctx = document.getElementById("lossPie").getContext("2d");

  window.lossChart = new Chart(ctx, {
    type: "pie",
    data: {
      labels,
      datasets: [{
        data,
        backgroundColor: labels.map(l => mistakeColorMap[l] || "#94a3b8"),
        hoverOffset: 16 
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          display: false
        },
        tooltip: {
          callbacks: {
            label: ctx => {
              const total = ctx.dataset.data.reduce((a,b)=>a+b,0);
              const pct = ((ctx.raw / total) * 100).toFixed(1);
              return `${ctx.label} ‚Äî ‚Çπ${ctx.raw} (${pct}%)`;
            }
          }
        }
      }
    }
  });
}

function buildMistakeHeatmap(trades) {
  const container = document.getElementById("mistakeHeatmap");
  if (!container) return;
  container.innerHTML = "";
  const impactByMistake = {};
  trades.forEach(t => {
    if (t.isBrokerage) return;
    if (!t.rules || !t.rules.length) return;
    const impact = Math.abs(t.pnl);
    t.rules.forEach(rule => {
      impactByMistake[rule] =
        (impactByMistake[rule] || 0) + impact;
    });
  });

  const entries = Object.entries(impactByMistake)
    .sort((a,b) => b[1] - a[1])
    .slice(0,5);
  if (!entries.length) return;
  const max = entries[0][1];
  entries.forEach(([mistake, value]) => {
    const height = (value / max) * 100;
    const color = mistakeColorMap[mistake] || "#94a3b8";
    const short = mistake
      .replace("No Stop Loss","NO SL")
      .replace("FOMO Entry","FOMO")
      .replace("Target 2 with SL","T2 SL")
      .replace("Free Channel with SL","Free SL")
      .replace("Free Channel Target Hit","Free T1")
      .replace("Stop Loss Hit","SL Hit")
      .replace("Target 1 Hit","T1 Hit");
    container.innerHTML += `
      <div class="bar-col">
        <div class="bar" style="height:${height}%; background:${color}"></div>
        <div class="bar-value">‚Çπ${Math.round(value)}</div>
        <div class="bar-label">${short}</div>
      </div>
    `;
  });
}

/* EXPORT */
function exportCSV(){
  db.transaction("trades","readonly")
    .objectStore("trades")
    .getAll()
    .onsuccess = e => {
      let csv = "Date,Instrument,PnL,Mistakes\n";
      e.target.result.forEach(x => {
        const instrument = x.instrument || "";
        const mistakes = Array.isArray(x.rules) && x.rules.length
          ? x.rules.join(", ")
          : "";

        csv += `${x.date},${instrument},${x.pnl},"${mistakes}"\n`;
      });
      const blob = new Blob([csv], { type: "text/csv" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "trading-journal.csv";
      a.click();
    };
}


/* HELPERS */
const pnlEl=()=>document.getElementById("pnl");
function clearForm(){
  date.value=""; pnl.value="";
  document.querySelectorAll("input[type=checkbox]").forEach(c=>c.checked=false);
}

function changeMonth(delta){
  currentMonth += delta;
  if (currentMonth < 0) {
    currentMonth = 11;
    currentYear--;
  }
  if (currentMonth > 11) {
    currentMonth = 0;
    currentYear++;
  }
  loadAll();  
}

function buildInstrumentPerformance(trades) {
  const now = new Date();
  const startDate = new Date(now.getFullYear(), 1, 1); // 1 Feb current year
  const container = document.getElementById("instrumentStats");
  if (!container) return;
  container.innerHTML = "";
  const instruments = {
    NIFTY: {
      pnl: 0,
      trades: 0,
      wins: 0,
      losses: 0
    },
    SENSEX: {
      pnl: 0,
      trades: 0,
      wins: 0,
      losses: 0
    }
  };

  trades.forEach(t => {
    // ‚ùå Ignore brokerage & invalid data
    const d = new Date(t.date);
    if (d < startDate) return;  // üîí only from 1 Feb this year
    if (!t.instrument) return;
    if (t.instrument === "BROKERAGE") return;
    if (!instruments[t.instrument]) return;
    instruments[t.instrument].trades += 1;
    instruments[t.instrument].pnl += t.pnl;
    if (t.pnl > 0) instruments[t.instrument].wins += 1;
    if (t.pnl < 0) instruments[t.instrument].losses += 1;
  });

  Object.entries(instruments).forEach(([name, data]) => {
    if (data.trades === 0) return;
    const pnlClass = data.pnl >= 0 ? "profit" : "loss";
    const sign = data.pnl >= 0 ? "‚Çπ" : "-‚Çπ";
    container.innerHTML += `
      <div class="instrument-card ${pnlClass}">
        <div class="instrument-name">${name}</div>
        <div class="instrument-pnl ${pnlClass}">
          ${sign}${Math.abs(data.pnl).toLocaleString()}
        </div>
        <div class="instrument-trades">
          ${data.trades} trades
        </div>
        <div class="instrument-wl">
          <span class="win">${data.wins}W</span> /
          <span class="loss">${data.losses}L</span>
        </div>
      </div>
    `;
  });
}

function buildWeekdaySuccessRate(trades) {
  const container = document.getElementById("weekdayStats");
  if (!container) return;

  container.innerHTML = "";

  const now = new Date();
  const startDate = new Date(now.getFullYear(), 1, 1); // 1 Feb current year

  const days = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];

  const map = {
    Mon:{t:0,w:0,p:0,pos:0,neg:0},
    Tue:{t:0,w:0,p:0,pos:0,neg:0},
    Wed:{t:0,w:0,p:0,pos:0,neg:0},
    Thu:{t:0,w:0,p:0,pos:0,neg:0},
    Fri:{t:0,w:0,p:0,pos:0,neg:0}
  };

  trades.forEach(t => {
    if (t.isBrokerage) return;

    const d = new Date(t.date);
    if (d < startDate) return;  // üîí only from 1 Feb this year

    const day = days[d.getDay()];
    if (!map[day]) return;

    map[day].t++;
    map[day].p += t.pnl;

    if (t.pnl > 0) {
      map[day].w++;
      map[day].pos += t.pnl;
    }

    if (t.pnl < 0) {
      map[day].neg += Math.abs(t.pnl);
    }
  });

  Object.entries(map).forEach(([day, d]) => {
    if (d.t === 0) return;

    const winRate = Math.round((d.w / d.t) * 100);

    const totalAbs = d.pos + d.neg;
    const pnlScore = totalAbs === 0
      ? 0
      : Math.round((d.p / totalAbs) * 100);

    const pnlClass = d.p >= 0 ? "#16a34a" : "#dc2626";

    container.innerHTML += `
      <div style="
        min-width:160px;
        padding:16px;
        border-radius:12px;
        background: #f1f5f9;
        border:1px solid #23beaf;
        box-shadow:0 2px 8px rgba(0,0,0,0.05);
      ">

        <div style="font-size:13px;color:#6b7280;margin-bottom:6px;">
          ${day}
        </div>

        <div style="
          font-size:18px;
          font-weight:700;
          color:${pnlClass};
          line-height:1;
          float:right;
  	      margin-top:-4px;
        ">
          ${pnlScore >= 0 ? "+" : ""}${pnlScore}%
        </div>

        <div style="
          font-size:11px;
          color:#9ca3af;
          margin-bottom:10px;
          margin-top:10px;
        ">
          PnL Quality
        </div>

        <div style="border-top:1px solid #f1f5f9;margin:8px 0;"></div>

        <div style="font-size:13px;margin-bottom:7px;">
          <span style="color:#6b7280;">Win Rate</span>
          <span style="float:right;font-weight:600;">
            ${winRate}%
          </span>
        </div>

        <div style="font-size:13px;margin-bottom:7px;">
          <span style="color:#6b7280;">Net</span>
          <span style="float:right;font-weight:600;color:${pnlClass};">
            ${d.p >= 0 ? "‚Çπ" : "-‚Çπ"}${Math.abs(d.p).toLocaleString()}
          </span>
        </div>

        <div style="font-size:12px;color:#9ca3af;margin-top:6px;">
          ${d.t} trades
        </div>

      </div>
    `;
  });
}

function openTaxesDrill() {

  const drill = document.getElementById("taxDrill");
  const container = document.getElementById("brokerageAccordion");

  drill.classList.remove("hidden");
  container.innerHTML = "";

  const tx = db.transaction("trades", "readonly");
  const store = tx.objectStore("trades");
  const req = store.getAll();

  req.onsuccess = () => {

    const brokerageTrades = req.result
      .filter(t => t.isBrokerage === true)
      .sort((a,b) => new Date(b.date) - new Date(a.date));

    if (!brokerageTrades.length) {
      container.innerHTML = "<div style='color:#6b7280;padding:12px;'>No brokerage data</div>";
      return;
    }

    // Group by Month
    const monthMap = {};

    brokerageTrades.forEach(t => {
      const d = new Date(t.date);
      const key = `${d.getFullYear()}-${d.getMonth()}`;
      const label = d.toLocaleString("default", { month: "long", year: "numeric" });

      if (!monthMap[key]) {
        monthMap[key] = {
          label,
          total: 0,
          trades: []
        };
      }

      monthMap[key].total += Math.abs(t.pnl);
      monthMap[key].trades.push(t);
    });

    Object.values(monthMap).forEach((month, index) => {
      const monthDiv = document.createElement("div");
      monthDiv.className = "brokerage-month";
      monthDiv.innerHTML = `
        <div class="brokerage-header">
          <div>
            ${month.label}
            <span class="brokerage-count">${month.trades.length} entries</span>
          </div>
          <div class="brokerage-total">
            ‚Çπ${month.total.toLocaleString()}
          </div>
        </div>
        <div class="brokerage-body"></div>
      `;

      const body = monthDiv.querySelector(".brokerage-body");
      month.trades.forEach(t => {
        body.innerHTML += `
          <div class="brokerage-row">
            <div>${t.date}</div>
            <div class="brokerage-amount">-‚Çπ${Math.abs(t.pnl).toLocaleString()}</div>
          </div>
        `;
      });
      // Click animation
      monthDiv.querySelector(".brokerage-header").addEventListener("click", () => {
        monthDiv.classList.toggle("active");
      });
      // Auto expand latest month
      if (index === 0) {
        monthDiv.classList.add("active");
      }
      container.appendChild(monthDiv);
    });
    // Smooth scroll to it
    drill.scrollIntoView({ behavior: "smooth" });
  };
}


function buildMistakeAnalysis(trades) {
  const container = document.getElementById("mistakeStats");
  const template = document.getElementById("mistakeTemplate");
  if (!container || !template) return;
  container.innerHTML = "";
  // üî• MUST match checkbox values EXACTLY
  const allowedMistakes = [
    "Stop Loss Hit",
    "FOMO Entry",
    "No Stop Loss",
    "Free Channel with SL",
    "Target 2 with SL"
  ];

  const map = {};
  allowedMistakes.forEach(m => {
    map[m] = { totalLoss: 0, trades: 0 };
  });
  trades.forEach(t => {
    if (t.isBrokerage) return;
    if (!t.rules || !t.rules.length) return;
    t.rules.forEach(rule => {
      if (map[rule] && t.pnl < 0) {
        map[rule].totalLoss += Math.abs(t.pnl);
        map[rule].trades++;
      }
    });
  });

  Object.entries(map).forEach(([mistake, data]) => {
  if (data.trades === 0) return;
  const totalLoss = data.totalLoss;
  const perTradeCost = Math.round(totalLoss / data.trades);
  const clone = template.content.cloneNode(true);
  clone.querySelector(".mistake-title").textContent = mistake;
  // üî• BIG VALUE = PER TRADE COST
  clone.querySelector(".mistake-amount").textContent =
    "‚Çπ" + perTradeCost.toLocaleString() + " / trade";
  // üî• META LINE = trades + total loss
  clone.querySelector(".mistake-trades").textContent =
    data.trades + " trades ‚Ä¢ ‚Çπ" + totalLoss.toLocaleString();
  container.appendChild(clone);
});
}

function calculateWinningStreaks(trades) {
  const dailyNet = {};
  // Build daily net (exclude brokerage)
  trades.forEach(t => {
    if (t.isBrokerage) return;
    dailyNet[t.date] = (dailyNet[t.date] || 0) + t.pnl;
  });
  // Sort dates ascending
  const sortedDates = Object.keys(dailyNet)
    .sort((a,b) => new Date(a) - new Date(b));
  const streakMap = {};
  let streak = 0;
  sortedDates.forEach(date => {
    const pnl = dailyNet[date];
    if (pnl >= 1000) {
      streak++;
    }
    else if (pnl < 0) {
      streak = 0;
    }
    else {
      // small profit but below threshold
      streak = 0;
    }
    if (streak > 1) {   // show only meaningful streaks
      streakMap[date] = streak;
    }
  });
  return streakMap;
}

function toggleSection(header){
  const card = header.closest(".collapsible");
  card.classList.toggle("collapsed");
}

const canvas = document.getElementById("particles-bg");
const ctx = canvas.getContext("2d");

canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

window.addEventListener("resize", () => {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
});

const mouse = {
  x: null,
  y: null,
  radius: 120
};

window.addEventListener("mousemove", (e) => {
  mouse.x = e.x;
  mouse.y = e.y;
});

class Particle {
  constructor() {
    this.x = Math.random() * canvas.width;
    this.y = Math.random() * canvas.height;
    this.size = Math.random() * 2 + 1;
    this.speedX = (Math.random() - 1.0) * 1.9;
    this.speedY = (Math.random() - 1.0) * 1.9;
  }

  update() {
    this.x += this.speedX;
    this.y += this.speedY;

    if (this.x < 0 || this.x > canvas.width) this.speedX *= -1;
    if (this.y < 0 || this.y > canvas.height) this.speedY *= -1;

    // mouse repulse
    let dx = this.x - mouse.x;
    let dy = this.y - mouse.y;
    let distance = Math.sqrt(dx * dx + dy * dy);

    if (distance < mouse.radius) {
      this.x += dx / 10;
      this.y += dy / 10;
    }
  }

  draw() {
    ctx.fillStyle = "rgba(35, 190, 175, 0.8)";
    ctx.beginPath();
    ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
    ctx.fill();
  }
}

const particles = [];
const particleCount = 120;

function initParticles() {
  for (let i = 0; i < particleCount; i++) {
    particles.push(new Particle());
  }
}

function connectParticles() {
  for (let a = 0; a < particles.length; a++) {
    for (let b = a; b < particles.length; b++) {
      let dx = particles[a].x - particles[b].x;
      let dy = particles[a].y - particles[b].y;
      let distance = dx * dx + dy * dy;

      if (distance < 12000) {
        ctx.strokeStyle = "rgba(35, 190, 175, 0.15)";
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.moveTo(particles[a].x, particles[a].y);
        ctx.lineTo(particles[b].x, particles[b].y);
        ctx.stroke();
      }
    }
  }
}

function animate() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  particles.forEach(p => {
    p.update();
    p.draw();
  });
  connectParticles();
  requestAnimationFrame(animate);
}
initParticles();
animate();

if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("sw.js");
}
</script>
</body>
</html>











































