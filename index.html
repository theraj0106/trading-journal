<!DOCTYPE html>
<html lang="en">
<head>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#2563eb">
<meta charset="UTF-8">
<title>Trading Journal</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{
  font-family: Arial, sans-serif;
  background:#f4f6f8;
  margin:0;
}
.container{
  max-width:1200px;
  margin:auto;
  padding:20px;
}
.card{
  background:#fff;
  padding:16px;
  border-radius:10px;
  margin-bottom:16px;
  border:1px solid #ddd;
}
h2,h3{margin:0 0 10px}

/* ---------- LAYOUT ---------- */
.trade-layout{
  display:flex;
  gap:20px;
}
.trade-form{
  width:42%;
}

.trade-chart{
  width:58%;
}


/* ---------- INPUTS ---------- */
label{
  font-size:13px;
  color:#555;
  display:block;
  margin-bottom:4px;
}
input{
  padding:6px 8px;
  font-size:13px;
  border-radius:6px;
  border:1px solid #d1d5db;
}

.input-row{
  display:flex;
  gap:12px;
  align-items:flex-end;
}
.input-group{
  display:flex;
  flex-direction:column;
}
.date-input{width:160px}
.pnl-input{width:120px}

/* ---------- CHECKBOXES ---------- */
/* ---------- CHECKBOXES (COMPACT PREMIUM) ---------- */
.rules{
  display:grid;
  grid-template-columns:repeat(3, auto);
  gap:6px 8px;
  margin-top:6px;
}

.rules label{
  display:flex;
  align-items:center;
  gap:6px;
  font-size:12px;
  background:#f9fafb;
  padding:4px 8px;          /* â¬… reduced padding */
  border-radius:6px;
  border:1px solid #e5e7eb;
  cursor:pointer;
  line-height:1.2;
}

.rules input{
  width:12px;               /* â¬… smaller checkbox */
  height:12px;
  margin:0;
}

.rules label:hover{
  background:#f1f5f9;
}
/* ---------- BUTTONS ---------- */
button{
  padding:7px 14px;
  border:none;
  border-radius:6px;
  cursor:pointer;
  font-size:13px;
}
.save{background:#2563eb;color:#fff}
.export{background:#374151;color:#fff;margin-left:8px}

/* ---------- SUMMARY ---------- */
.summary{
  display:flex;
  gap:20px;
  flex-wrap:wrap;
}
.summary span{
  font-size:16px;
  font-weight:bold;
}

/* ---------- CALENDAR ---------- */
.calendar{
  display:grid;
  grid-template-columns:repeat(7,1fr);
  gap:8px;
}
.day-header{
  text-align:center;
  font-size:12px;
  color:#666;
}
.day{
  min-height:68px;
  padding:6px;
  border-radius:6px;
  font-size:12px;
  cursor:pointer;
}
.green{background:#e6f7ec;color:#166534}
.red{background:#fdecec;color:#991b1b}
.neutral{background:#f1f5f9;color:#555}

/* ---- Calendar UI polish ---- */
.day{
  position: relative; /* required for positioning */
  transition: transform 0.1s ease, box-shadow 0.1s ease;
}
.day:active{
  transform: scale(0.97);
}
.day:hover{
  filter: brightness(0.97);
}

/* Date top-right (quiet, not bold) */
.day-date{
  position: absolute;
  top: 6px;
  right: 6px;
  font-size: 13px;
  font-weight: normal;
  opacity: 0.75;
}

/* PnL hero (left aligned) */
.day-pnl{
  margin-top: 20px;
  font-size: 16px;      /* slightly bigger */
  font-weight: bold;   /* bold */
}

/* Bottom-right details */
.day-details{
  position: absolute;
  right: 6px;
  bottom: 6px;
  text-align: right;
  font-size: 12px;
  line-height: 1.4;
  opacity: 0.8;
}


/* ---------- TABLE ---------- */
.hidden{display:none}
table{
  width:100%;
  border-collapse:collapse;
}
th,td{
  border-bottom:1px solid #ddd;
  padding:8px;
  font-size:13px;
  text-align:left;
}
th{background:#f8fafc}
.pnl-col{width:120px;font-weight:bold}

/* ---------- PIE ---------- */
.trade-chart h3{
  font-size:15px;
  color:#374151;
  margin-bottom:8px;
}

/* ---- PIE SIZE CONTROL ---- */
.pie-wrapper{
  width:100%;
  max-width:260px;        /* controls width */
  height:260px;           /* controls height */
  margin:auto;
}

.trade-chart canvas{
  width:100% !important;
  height:100% !important;
}

  .calendar-day {
  border-radius: 10px;
  padding: 10px;
  min-height: 95px;
  font-size: 13px;
}

.calendar-day.profit {
  background: #e9f9ee; /* green */
}

.calendar-day.loss {
  background: #fdecec; /* red */
}

.calendar-pnl.profit {
  color: #15803d;
  font-weight: bold;
}

.calendar-pnl.loss {
  color: #b91c1c;
  font-weight: bold;
}

.calendar-meta {
  margin-top: 2px;
}

.calendar-wl {
  margin-top: 6px;
  font-weight: bold;
  font-size: 12px;
}
/* ---- Summary UI ---- */
.summary-cards{
  display:flex;
  gap:16px;
  flex-wrap:wrap;
}

.summary-box{
  flex:1;
  min-width:200px;
  background:#f9fafb;
  border:1px solid #e5e7eb;
  border-radius:10px;
  padding:16px;
}

.summary-label{
  font-size:12px;
  text-transform:uppercase;
  color:#6b7280;
  margin-bottom:6px;
}

.summary-value{
  font-size:24px;
  font-weight:bold;
  line-height:1.2;
}

/* Color accents */
.profit-box .summary-value{ color:#16a34a; }
.loss-box .summary-value{ color:#dc2626; }
.net-box .summary-value{ color:#16a34a; }

/* ---- Drill-down table (final) ---- */

/* PnL */
.pnl{
  font-weight:bold;
}
.pnl.profit{
  color:#16a34a;
}
.pnl.loss{
  color:#dc2626;
}

/* Mistake tag */
.mistake{
  display:inline-block;
  padding:4px 10px;
  font-size:12px;
  border-radius:999px;
  background:#f1f5f9;
  color:#374151;
  border:1px solid #e5e7eb;
}

/* Mistake on loss */
.mistake.loss{
  background:#fee2e2;
  color:#b91c1c;
  border-color:#fecaca;
}
.mistake-card.bad:hover{
  background:#fee2e2;        /* light red */
  border-color:#fecaca;
  color:#991b1b;
}

/* GOOD / DISCIPLINED â†’ GREEN hover */
.mistake-card.good:hover{
  background:#dcfce7;        /* light green */
  border-color:#bbf7d0;
  color:#166534;
}
/* ---------- MISTAKE HEATMAP ---------- */
.heatmap{
  display:flex;
  align-items:flex-end;
  gap:18px;
  height:220px;              /* REQUIRED */
  padding-bottom:6px;
}

.bar-col{
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:flex-end;
  height:100%;
}

.bar{
  width:34px;
  border-radius:6px 6px 0 0;
}

/* Red intensity */
.bar.high{ background:#b91c1c; }
.bar.medium{ background:#dc2626; }
.bar.low{ background:#f87171; }

.bar-value{
  margin-top:6px;
  font-size:12px;
  font-weight:bold;
  color:#991b1b;
}

.bar-label{
  font-size:11px;
  color:#374151;
  text-align:center;
  white-space:nowrap;
}

  /* ---------- CHECKBOXES (COMPACT PREMIUM â€“ FINAL) ---------- */
.rules{
  display:grid;
  grid-template-columns:repeat(3, auto); /* dense grid */
  gap:6px 8px;
  margin-top:6px;
}

.rules label{
  display:flex;
  align-items:center;
  gap:6px;
  font-size:12px;
  background:#f9fafb;
  padding:4px 8px;          
  border-radius:6px;
  border:1px solid #e5e7eb;
  cursor:pointer;
  line-height:1.2;

  white-space:nowrap;       
  max-width:fit-content;    
}

.rules input{
  width:12px;              
  height:12px;
  margin:0;
}

.rules label:hover{
  background:#f1f5f9;
}

</style>
</head>

<body>
<div class="container">

<!-- ADD TRADE + PIE -->
<div class="card">
<h2>Add Trade</h2>

<div class="trade-layout">

  <!-- LEFT 50% -->
  <div class="trade-form">

    <div class="input-row">
      <div class="input-group">
        <label>Date</label>
        <input type="date" id="date" class="date-input">
      </div>

      <div class="input-group">
        <label>PnL</label>
        <input type="number" id="pnl" class="pnl-input" placeholder="+ / -">
      </div>
    </div>

    <label style="margin-top:10px">Mistakes</label>
  <div class="rules"> <label class="mistake-card bad">   <input type="checkbox" value="No Stop Loss"> No SL </label> 
   <label class="mistake-card bad">   <input type="checkbox" value="Free Channel with SL"> Free SL </label>
   <label class="mistake-card bad">  <input type="checkbox" value="FOMO Entry"> FOMO </label>
   <label class="mistake-card bad">   <input type="checkbox" value="Target 2 with SL"> T2 SL </label>
   <label class="mistake-card good"> <input type="checkbox" value="Target 1 Hit"> T1 Hit </label>
   <label class="mistake-card good"> <input type="checkbox" value="Free Channel Target Hit"> Free T1 </label>
   <label class="mistake-card bad"> <input type="checkbox" value="Stop Loss Hit"> SL Hit </label>
    </div>

    <div style="margin-top:12px">
      <button class="save" onclick="saveTrade()">Save</button>
      <button class="export" onclick="exportCSV()">Export</button>
    </div>

  </div>

  <!-- RIGHT 50% -->
  <div class="trade-chart">
  <div style="display:flex; gap:24px; align-items:flex-end">

    <!-- PIE -->
    <div>
      <h3>Profit & Loss Distribution</h3>
      <div class="pie-wrapper">
        <canvas id="lossPie"></canvas>
      </div>
    </div>

    <!-- HEATMAP -->
    <div>
      <h3>Mistake Impact (â‚¹)</h3>
      <div class="heatmap" id="mistakeHeatmap"></div>
    </div>

  </div>
</div>


</div>
</div>

<!-- SUMMARY -->
<div class="card">
  <h2>Summary</h2>
  <div class="summary-cards">
    <div class="summary-box profit-box">
      <div class="summary-label">Total Profit</div>
      <div class="summary-value" id="profit">â‚¹0</div>
    </div>
    <div class="summary-box loss-box">
      <div class="summary-label">Total Loss</div>
      <div class="summary-value" id="loss">â‚¹0</div>
    </div>
    <div class="summary-box net-box">
      <div class="summary-label">Net P&amp;L</div>
      <div class="summary-value" id="net">â‚¹0</div>
    </div>
  </div>
</div>

<!-- CALENDAR -->
<div class="card">
<h2>ðŸ“… Calendar</h2>
<div class="calendar" id="calendar"></div>
</div>

<!-- DRILL -->
<div class="card hidden" id="drill">
<h3 id="drillTitle"></h3>
<table>
<thead>
<tr><th class="pnl-col">PnL</th><th>Mistakes</th></tr>
</thead>
<tbody id="drillBody"></tbody>
</table>
</div>

</div>

<script>
let db, lossChart;
const mistakeColorMap = {
  "No Stop Loss": "#dc2626",
  "Target 2 with SL": "#b91c1c",
  "FOMO Entry": "#f59e0b",
  "Free Channel with SL": "#fb923c",
  "Free Channel Target Hit": "#ea580c",
  "Stop Loss Hit": "#60a5fa",
  "Target 1 Hit": "#22c55e"
};

/* DB */
const req=indexedDB.open("TradeJournalDB",1);
req.onupgradeneeded=e=>{
  e.target.result.createObjectStore("trades",{keyPath:"id",autoIncrement:true});
};
req.onsuccess=e=>{
  db=e.target.result;
  loadAll();
};

/* SAVE */
function saveTrade() {
  const dateValue = document.getElementById("date").value;
  const pnlValue  = Number(document.getElementById("pnl").value);

  if (!dateValue || pnlValue === 0) {
    alert("Date & PnL required");
    return;
  }

  // ðŸ”’ HARD COLLECTION (no assumptions)
  const ruleNodes = document.querySelectorAll(".rules input[type=checkbox]");
  const rules = [];

  ruleNodes.forEach(cb => {
    if (cb.checked) {
      rules.push(cb.value);
    }
  });

  const trade = {
    date: dateValue,
    pnl: pnlValue,
    rules: rules   // ðŸ‘ˆ ALWAYS SAVED AS-IS
  };

  console.log("âœ… SAVED TRADE:", trade);

  const tx = db.transaction("trades", "readwrite");
  tx.objectStore("trades").add(trade);

  tx.oncomplete = () => {
    clearForm();
    loadAll();
  };
}

/* LOAD */
function loadAll(){
  db.transaction("trades","readonly")
    .objectStore("trades").getAll().onsuccess=e=>{
      const t=e.target.result;
      updateSummary(t);
      buildCalendar(t);
      buildLossPie(t);
      buildMistakeHeatmap(t);
    };
}

/* SUMMARY */
function updateSummary(t){
  let p=0,l=0;
  t.forEach(x=>{if(x.pnl>0)p+=x.pnl;if(x.pnl<0)l+=Math.abs(x.pnl);});
  profit.innerText="â‚¹"+p;
  loss.innerText="â‚¹"+l;
  net.innerText="â‚¹"+(p-l);
}

/* CALENDAR */
function buildCalendar(t){
  calendar.innerHTML = "";

  const d = new Date(),
        y = d.getFullYear(),
        m = d.getMonth();

  const first = new Date(y, m, 1).getDay() || 7;
  const days  = new Date(y, m + 1, 0).getDate();

  const map = {};
  t.forEach(x => {
    map[x.date] = (map[x.date] || []).concat(x);
  });

  ["Mon","Tue","Wed","Thu","Fri","Sat","Sun"]
    .forEach(h => calendar.innerHTML += `<div class="day-header">${h}</div>`);

  for (let i = 1; i < first; i++) {
    calendar.innerHTML += `<div></div>`;
  }

  for (let i = 1; i <= days; i++) {
    const ds = `${y}-${String(m+1).padStart(2,"0")}-${String(i).padStart(2,"0")}`;
    const list = map[ds] || [];

    if (list.length === 0) {
      calendar.innerHTML += `
        <div class="day neutral">
          <div class="day-date">${i}</div>
          No Trades
        </div>`;
      continue;
    }

    let pnl = 0, wins = 0, losses = 0;

    list.forEach(x => {
      pnl += x.pnl;
      if (x.pnl > 0) wins++;
      if (x.pnl < 0) losses++;
    });

    const colorClass = pnl >= 0 ? "green" : "red";

    calendar.innerHTML += `
      <div class="day ${colorClass}" onclick="openDay('${ds}')">
        <div class="day-date">${i}</div>

        <div class="day-pnl">â‚¹${pnl}</div>

        <div class="day-details">
          ${list.length} trades<br>
          ${wins}W / ${losses}L
        </div>
      </div>`;
  }
}

/* DRILL */
function openDay(selectedDate) {
  const drill = document.getElementById("drill");
  const drillTitle = document.getElementById("drillTitle");
  const drillBody = document.getElementById("drillBody");

  drill.classList.remove("hidden");
  drillTitle.innerText = "Trades on " + selectedDate;
  drillBody.innerHTML = "";

  const tx = db.transaction("trades", "readonly");
  const store = tx.objectStore("trades");
  const req = store.getAll();

  req.onsuccess = () => {
    req.result
      .filter(t => t.date === selectedDate)
      .forEach(t => {
        drillBody.innerHTML += `
      <tr>
        <td class="pnl-col pnl ${t.pnl < 0 ? 'loss' : 'profit'}">
          ${t.pnl >= 0 ? "â‚¹" + t.pnl : "-â‚¹" + Math.abs(t.pnl)}
      </td>
      <td>
        ${
          Array.isArray(t.rules) && t.rules.length
            ? `<span class="mistake ${t.pnl < 0 ? 'loss' : ''}">
               ${t.rules.join(", ")}
             </span>`
          : "-"
        }
    </td>
  </tr>
`;
      });
  };
}

/* PIE */
function buildLossPie(trades) {
  const impactByMistake = {};

  trades.forEach(t => {
    if (!t.rules || t.rules.length === 0) return;

    const impact = Math.abs(t.pnl); // profit + loss

    t.rules.forEach(rule => {
      impactByMistake[rule] =
        (impactByMistake[rule] || 0) + impact;
    });
  });

  // Destroy old chart (CRITICAL)
  if (window.lossChart) {
    window.lossChart.destroy();
    window.lossChart = null;
  }

  const labels = Object.keys(impactByMistake);
  const data = Object.values(impactByMistake);

  if (labels.length === 0) return;

  // âœ… Behavior-based color mapping (order safe)
  const colorMap = {
  /* âŒ BAD / HIGH RISK */
  "No Stop Loss": "#dc2626",            // deep red â€“ capital protection failure
  "Target 2 with SL": "#b91c1c",         // dark red â€“ greed (should exit at T1)
  "FOMO Entry": "#f59e0b",               // amber â€“ emotional entry
  /* âš ï¸ NOT IDEAL / EXTERNAL */
  "Free Channel with SL": "#fb923c",     // orange â€“ external dependency (some control)
  "Free Channel Target Hit": "#ea580c",  // orange â€“ profit but not own setup
  /* ðŸŸ¦ DISCIPLINED LOSS */
  "Stop Loss Hit": "#60a5fa",            // blue â€“ rule-based loss
  /* âœ… GOOD / DISCIPLINED */
  "Target 1 Hit": "#22c55e"             // green â€“ correct execution
  };


  const colors = labels.map(l => colorMap[l] || "#94a3b8");

  const ctx = document.getElementById("lossPie").getContext("2d");

  window.lossChart = new Chart(ctx, {
    type: "pie",
    data: {
      labels,
      datasets: [{
        data,
        backgroundColor: labels.map(l => mistakeColorMap[l] || "#94a3b8")
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: "bottom"
        },
        tooltip: {
          callbacks: {
            label: ctx => {
              const total = ctx.dataset.data.reduce((a,b)=>a+b,0);
              const pct = ((ctx.raw / total) * 100).toFixed(1);
              return `${ctx.label} â€” â‚¹${ctx.raw} (${pct}%)`;
            }
          }
        }
      }
    }
  });
}

function buildMistakeHeatmap(trades) {
  const container = document.getElementById("mistakeHeatmap");
  if (!container) return;

  container.innerHTML = "";

  const impactByMistake = {};

  trades.forEach(t => {
    if (!t.rules || !t.rules.length) return;

    const impact = Math.abs(t.pnl);

    t.rules.forEach(rule => {
      impactByMistake[rule] =
        (impactByMistake[rule] || 0) + impact;
    });
  });

  const entries = Object.entries(impactByMistake)
    .sort((a,b) => b[1] - a[1])
    .slice(0,5);

  if (!entries.length) return;

  const max = entries[0][1];

  entries.forEach(([mistake, value]) => {
    const height = (value / max) * 100;
    const color = mistakeColorMap[mistake] || "#94a3b8";
    const short = mistake
      .replace("No Stop Loss","No SL")
      .replace("FOMO Entry","FOMO")
      .replace("Target 2 with SL","T2 SL")
      .replace("Free Channel with SL","Free Ch SL")
      .replace("Free Channel Target Hit","Free Ch T1")
      .replace("Stop Loss Hit","SL Hit")
      .replace("Target 1 Hit","T1 Hit");

    container.innerHTML += `
      <div class="bar-col">
        <div class="bar" style="height:${height}%; background:${color}"></div>
        <div class="bar-value">â‚¹${Math.round(value)}</div>
        <div class="bar-label">${short}</div>
      </div>
    `;
  });
}


/* EXPORT */
function exportCSV(){
  db.transaction("trades","readonly").objectStore("trades").getAll().onsuccess=e=>{
    let csv="Date,PnL,Mistakes\n";
    e.target.result.forEach(x=>csv+=`${x.date},${x.pnl},"${x.rules.join(", ")}"\n`);
    const a=document.createElement("a");
    a.href=URL.createObjectURL(new Blob([csv]));
    a.download="trading-journal.csv";
    a.click();
  };
}

/* HELPERS */
const pnlEl=()=>document.getElementById("pnl");
function clearForm(){
  date.value=""; pnl.value="";
  document.querySelectorAll("input[type=checkbox]").forEach(c=>c.checked=false);
}

if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("sw.js");
}

</script>

</body>
</html>















