<!DOCTYPE html>
<html lang="en">
<head>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#2563eb">
<meta charset="UTF-8">
<title>Trading Journal</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{
  font-family: Arial, sans-serif;
  background:#f4f6f8;
  margin:0;
}
.container{
  max-width:1200px;
  margin:auto;
  padding:20px;
}
.card{
  background:#fff;
  padding:16px;
  border-radius:10px;
  margin-bottom:16px;
  border:1px solid #ddd;
}
h2,h3{margin:0 0 10px}

/* ---------- LAYOUT ---------- */
.trade-layout{
  display:flex;
  gap:20px;
}
.trade-form,
.trade-chart{
  width:50%;
}

/* ---------- INPUTS ---------- */
label{
  font-size:13px;
  color:#555;
  display:block;
  margin-bottom:4px;
}
input{
  padding:6px 8px;
  font-size:13px;
  border-radius:6px;
  border:1px solid #d1d5db;
}

.input-row{
  display:flex;
  gap:12px;
  align-items:flex-end;
}
.input-group{
  display:flex;
  flex-direction:column;
}
.date-input{width:160px}
.pnl-input{width:120px}

/* ---------- CHECKBOXES ---------- */
.rules{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:6px;
  margin-top:6px;
}
.rules label{
  display:flex;
  align-items:center;
  gap:6px;
  font-size:12.5px;
  background:#f9fafb;
  padding:6px 8px;
  border-radius:6px;
  border:1px solid #e5e7eb;
  cursor:pointer;
}
.rules input{
  width:13px;
  height:13px;
  margin:0;
}

/* ---------- BUTTONS ---------- */
button{
  padding:7px 14px;
  border:none;
  border-radius:6px;
  cursor:pointer;
  font-size:13px;
}
.save{background:#2563eb;color:#fff}
.export{background:#374151;color:#fff;margin-left:8px}

/* ---------- SUMMARY ---------- */
.summary{
  display:flex;
  gap:20px;
  flex-wrap:wrap;
}
.summary span{
  font-size:16px;
  font-weight:bold;
}

/* ---------- CALENDAR ---------- */
.calendar{
  display:grid;
  grid-template-columns:repeat(7,1fr);
  gap:8px;
}
.day-header{
  text-align:center;
  font-size:12px;
  color:#666;
}
.day{
  min-height:68px;
  padding:6px;
  border-radius:6px;
  font-size:12px;
  cursor:pointer;
}
.green{background:#e6f7ec;color:#166534}
.red{background:#fdecec;color:#991b1b}
.neutral{background:#f1f5f9;color:#555}

/* ---------- TABLE ---------- */
.hidden{display:none}
table{
  width:100%;
  border-collapse:collapse;
}
th,td{
  border-bottom:1px solid #ddd;
  padding:8px;
  font-size:13px;
  text-align:left;
}
th{background:#f8fafc}
.pnl-col{width:120px;font-weight:bold}

/* ---------- PIE ---------- */
.trade-chart h3{
  font-size:15px;
  color:#374151;
  margin-bottom:8px;
}

/* ---- PIE SIZE CONTROL ---- */
.pie-wrapper{
  width:100%;
  max-width:260px;        /* controls width */
  height:260px;           /* controls height */
  margin:auto;
}

.trade-chart canvas{
  width:100% !important;
  height:100% !important;
}

</style>
</head>

<body>
<div class="container">

<!-- ADD TRADE + PIE -->
<div class="card">
<h2>Add Trade</h2>

<div class="trade-layout">

  <!-- LEFT 50% -->
  <div class="trade-form">

    <div class="input-row">
      <div class="input-group">
        <label>Date</label>
        <input type="date" id="date" class="date-input">
      </div>
      
    <label>
      Instrument:
      <select id="instrument">
        <option value="NIFTY">NIFTY</option>
        <option value="SENSEX">SENSEX</option>
      </select>
    </label>
      
      <div class="input-group">
        <label>PnL</label>
        <input type="number" id="pnl" class="pnl-input" placeholder="+ / -">
      </div>
    </div>

    <label style="margin-top:10px">Mistakes</label>
    <div class="rules">
      <label><input type="checkbox" value="No Stop Loss"> No Stop Loss</label>
      <label><input type="checkbox" value="Free Channel with SL">   Free Channel with SL </label>
      <label><input type="checkbox" value="FOMO Entry">  FOMO Entry</label>
      <label><input type="checkbox" value="Free Channel Target Hit">  Free Channel Target Hit</label>
      <label><input type="checkbox" value="Target 2 with SL">  Target 2 with SL</label>
      <label><input type="checkbox" value="Target 1 Hit">  Target 1 Hit</label>
      <label><input type="checkbox" value="Stop Loss Hit">  Stop Loss Hit</label>
    </div>

    <div style="margin-top:12px">
      <button class="save" onclick="saveTrade()">Save</button>
      <button class="export" onclick="exportCSV()">Export</button>
    </div>

  </div>

  <!-- RIGHT 50% -->
  <div class="trade-chart">
    <h3>Profit &amp; Loss Distribution</h3>
   <div class="pie-wrapper">
  <canvas id="lossPie"></canvas>
</div>
  </div>

</div>
</div>

<!-- SUMMARY -->
<div class="card">
<h2>Summary</h2>
<div class="summary">
  <div>Total Profit<br><span id="profit" style="color:green">â‚¹0</span></div>
  <div>Total Loss<br><span id="loss" style="color:red">â‚¹0</span></div>
  <div>Net P&amp;L<br><span id="net">â‚¹0</span></div>
</div>
</div>

<!-- CALENDAR -->
<div class="card">
<h2>ðŸ“… Calendar</h2>
<div class="calendar" id="calendar"></div>
</div>

<!-- DRILL -->
<div class="card hidden" id="drill">
<h3 id="drillTitle"></h3>
<table>
<thead>
<tr><th class="pnl-col">PnL</th><th>Mistakes</th></tr>
</thead>
<tbody id="drillBody"></tbody>
</table>
</div>

</div>

<script>
let db, lossChart;

/* DB */
const req=indexedDB.open("TradeJournalDB",1);
req.onupgradeneeded=e=>{
  e.target.result.createObjectStore("trades",{keyPath:"id",autoIncrement:true});
};
req.onsuccess=e=>{
  db=e.target.result;
  loadAll();
};

/* SAVE */
function saveTrade() {
  const dateValue = document.getElementById("date").value;
  const pnlValue  = Number(document.getElementById("pnl").value);
  const instrument = document.getElementById("instrument").value;

  if (!dateValue || pnlValue === 0) {
    alert("Date & PnL required");
    return;
  }

  // ðŸ”’ HARD COLLECTION (no assumptions)
  const ruleNodes = document.querySelectorAll(".rules input[type=checkbox]");
  const rules = [];

  ruleNodes.forEach(cb => {
    if (cb.checked) {
      rules.push(cb.value);
    }
  });

  const trade = {
  date,
  pnl,
  rules: selectedRules,
  instrument
};


  console.log("âœ… SAVED TRADE:", trade);

  const tx = db.transaction("trades", "readwrite");
  tx.objectStore("trades").add(trade);

  tx.oncomplete = () => {
    clearForm();
    loadAll();
  };
}

/* LOAD */
function loadAll(){
  db.transaction("trades","readonly")
    .objectStore("trades").getAll().onsuccess=e=>{
      const t=e.target.result;
      updateSummary(t);
      buildCalendar(t);
      buildLossPie(t);
    };
}

/* SUMMARY */
function updateSummary(t){
  let p=0,l=0;
  t.forEach(x=>{if(x.pnl>0)p+=x.pnl;if(x.pnl<0)l+=Math.abs(x.pnl);});
  profit.innerText="â‚¹"+p;
  loss.innerText="â‚¹"+l;
  net.innerText="â‚¹"+(p-l);
}

function getPnLByInstrument(trades) {
  const summary = { NIFTY: 0, SENSEX: 0 };

  trades.forEach(t => {
    if (t.instrument) {
      summary[t.instrument] += t.pnl;
    }
  });

  return summary;
}


/* CALENDAR */
function buildCalendar(t){
  calendar.innerHTML="";
  const d=new Date(),y=d.getFullYear(),m=d.getMonth();
  const first=new Date(y,m,1).getDay()||7;
  const days=new Date(y,m+1,0).getDate();
  const map={};
  t.forEach(x=>map[x.date]=(map[x.date]||[]).concat(x));
  ["Mon","Tue","Wed","Thu","Fri","Sat","Sun"].forEach(h=>calendar.innerHTML+=`<div class="day-header">${h}</div>`);
  for(let i=1;i<first;i++)calendar.innerHTML+=`<div></div>`;
  for(let i=1;i<=days;i++){
    const ds=`${y}-${String(m+1).padStart(2,"0")}-${String(i).padStart(2,"0")}`;
    const list=map[ds]||[];
    let pnl=list.reduce((s,x)=>s+x.pnl,0);
    calendar.innerHTML+=`
      <div class="day ${pnl>0?"green":pnl<0?"red":"neutral"}" onclick="openDay('${ds}')">
        <b>${i}</b><br>${list.length?`â‚¹${pnl}<br>${list.length} trades`:"No Trades"}
      </div>`;
  }
}

/* DRILL */
function openDay(selectedDate) {
  const drill = document.getElementById("drill");
  const drillTitle = document.getElementById("drillTitle");
  const drillBody = document.getElementById("drillBody");

  drill.classList.remove("hidden");
  drillTitle.innerText = "Trades on " + selectedDate;
  drillBody.innerHTML = "";

  const tx = db.transaction("trades", "readonly");
  const store = tx.objectStore("trades");
  const req = store.getAll();

  req.onsuccess = () => {
    req.result
      .filter(t => t.date === selectedDate)
      .forEach(t => {

        console.log("ðŸ“– READ TRADE:", t);

        drillBody.innerHTML += `
          <tr>
            <td class="pnl-col">
              ${t.pnl >= 0 ? "â‚¹" + t.pnl : "-â‚¹" + Math.abs(t.pnl)}
            </td>
            <td>
              ${
                Array.isArray(t.rules) && t.rules.length
                  ? t.rules.join(", ")
                  : "-"
              }
            </td>
          </tr>
        `;
      });
  };
}

/* PIE */
function buildLossPie(trades) {
  const impactByMistake = {};

  trades.forEach(t => {
    if (!t.rules || t.rules.length === 0) return;

    const impact = Math.abs(t.pnl); // profit + loss

    t.rules.forEach(rule => {
      impactByMistake[rule] =
        (impactByMistake[rule] || 0) + impact;
    });
  });

  // Destroy old chart (CRITICAL)
  if (window.lossChart) {
    window.lossChart.destroy();
    window.lossChart = null;
  }

  const labels = Object.keys(impactByMistake);
  const data = Object.values(impactByMistake);

  if (labels.length === 0) return;

  // âœ… Behavior-based color mapping (order safe)
  const colorMap = {
  /* âŒ BAD / HIGH RISK */
  "No Stop Loss": "#dc2626",            // deep red â€“ capital protection failure
  "Target 2 with SL": "#b91c1c",         // dark red â€“ greed (should exit at T1)
  "FOMO Entry": "#f59e0b",               // amber â€“ emotional entry
  /* âš ï¸ NOT IDEAL / EXTERNAL */
  "Free Channel with SL": "#fb923c",     // orange â€“ external dependency (some control)
  "Free Channel Target Hit": "#ea580c",  // orange â€“ profit but not own setup
  /* ðŸŸ¦ DISCIPLINED LOSS */
  "Stop Loss Hit": "#60a5fa",            // blue â€“ rule-based loss
  /* âœ… GOOD / DISCIPLINED */
  "Target 1 Hit": "#22c55e"             // green â€“ correct execution
  };


  const colors = labels.map(l => colorMap[l] || "#94a3b8");

  const ctx = document.getElementById("lossPie").getContext("2d");

  window.lossChart = new Chart(ctx, {
    type: "pie",
    data: {
      labels,
      datasets: [{
        data,
        backgroundColor: colors
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: "bottom"
        },
        tooltip: {
          callbacks: {
            label: ctx => {
              const total = ctx.dataset.data.reduce((a,b)=>a+b,0);
              const pct = ((ctx.raw / total) * 100).toFixed(1);
              return `${ctx.label} â€” â‚¹${ctx.raw} (${pct}%)`;
            }
          }
        }
      }
    }
  });
}

/* EXPORT */
function exportCSV(){
  db.transaction("trades","readonly").objectStore("trades").getAll().onsuccess=e=>{
    let csv="Date,PnL,Mistakes\n";
    e.target.result.forEach(x=>csv+=`${x.date},${x.pnl},"${x.rules.join(", ")}"\n`);
    const a=document.createElement("a");
    a.href=URL.createObjectURL(new Blob([csv]));
    a.download="trading-journal.csv";
    a.click();
  };
}

/* HELPERS */
const pnlEl=()=>document.getElementById("pnl");
function clearForm(){
  date.value=""; pnl.value="";
  document.querySelectorAll("input[type=checkbox]").forEach(c=>c.checked=false);
}

if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("sw.js");
}

</script>

</body>
</html>







