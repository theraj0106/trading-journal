<!DOCTYPE html>
<html lang="en">
<head>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#2563eb">
<meta charset="UTF-8">
<title>Trading Journal</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{
  font-family: Arial, sans-serif;
  background:#f4f6f8;
  margin:0;
}
.container{
  max-width:1200px;
  margin:auto;
  padding:20px;
}
.card{
  background:#fff;
  padding:16px;
  border-radius:10px;
  margin-bottom:16px;
  border:1px solid #ddd;
}
h2,h3{margin:0 0 10px}

/* ---------- LAYOUT ---------- */
.trade-layout{
  display:flex;
  gap:20px;
}
.trade-form{
  width:42%;
}

.trade-chart{
  width:58%;
}


/* ---------- INPUTS ---------- */
label{
  font-size:13px;
  color:#555;
  display:block;
  margin-bottom:4px;
}
input{
  padding:6px 8px;
  font-size:13px;
  border-radius:6px;
  border:1px solid #d1d5db;
}

.input-row{
  display:flex;
  gap:12px;
  align-items:flex-end;
}
.input-group{
  display:flex;
  flex-direction:column;
}
.date-input{width:160px}
.pnl-input{width:120px}

/* ---------- CHECKBOXES ---------- */
/* ---------- CHECKBOXES (COMPACT PREMIUM) ---------- */
.rules{
  display:grid;
  grid-template-columns:repeat(3, auto);
  gap:6px 8px;
  margin-top:6px;
}

.rules label{
  display:flex;
  align-items:center;
  gap:6px;
  font-size:12px;
  background:#f9fafb;
  padding:4px 8px;          /* ‚¨Ö reduced padding */
  border-radius:6px;
  border:1px solid #e5e7eb;
  cursor:pointer;
  line-height:1.2;
}

.rules input{
  width:12px;               /* ‚¨Ö smaller checkbox */
  height:12px;
  margin:0;
}

.rules label:hover{
  background:#f1f5f9;
}
/* ---------- BUTTONS ---------- */
button{
  padding:7px 14px;
  border:none;
  border-radius:6px;
  cursor:pointer;
  font-size:13px;
}
.save{background:#2563eb;color:#fff}
.export{background:#374151;color:#fff;margin-left:8px}

/* ---------- SUMMARY ---------- */
.summary{
  display:flex;
  gap:20px;
  flex-wrap:wrap;
}
.summary span{
  font-size:16px;
  font-weight:bold;
}

/* ---------- CALENDAR ---------- */
.calendar{
  display:grid;
  grid-template-columns:repeat(7,1fr);
  gap:8px;
}
.day-header{
  text-align:center;
  font-size:12px;
  color:#666;
}
.day{
  min-height:68px;
  padding:6px;
  border-radius:6px;
  font-size:12px;
  cursor:pointer;
}
.green{background:#e6f7ec;color:#166534}
.red{background:#fdecec;color:#991b1b}
.neutral{background:#f1f5f9;color:#555}

/* ---- Calendar UI polish ---- */
.day{
  position: relative; /* required for positioning */
  transition: transform 0.1s ease, box-shadow 0.1s ease;
}
.day:active{
  transform: scale(0.97);
}
.day:hover{
  filter: brightness(0.97);
}

/* Date top-right (quiet, not bold) */
.day-date{
  position: absolute;
  top: 6px;
  right: 6px;
  font-size: 13px;
  font-weight: normal;
  opacity: 0.75;
}

/* PnL hero (left aligned) */
.day-pnl{
  margin-top: 20px;
  font-size: 16px;      /* slightly bigger */
  font-weight: bold;   /* bold */
}

/* Bottom-right details */
.day-details{
  position: absolute;
  right: 6px;
  bottom: 6px;
  text-align: right;
  font-size: 12px;
  line-height: 1.4;
  opacity: 0.8;
}


/* ---------- TABLE ---------- */
.hidden{display:none}
table{
  width:100%;
  border-collapse:collapse;
}
th,td{
  border-bottom:1px solid #ddd;
  padding:8px;
  font-size:13px;
  text-align:left;
}
th{background:#f8fafc}
.pnl-col{width:120px;font-weight:bold}

/* ---------- PIE ---------- */
.trade-chart h3{
  font-size:15px;
  color:#374151;
  margin-bottom:8px;
}

/* ---- PIE SIZE CONTROL ---- */
.pie-wrapper{
  width:100%;
  max-width:260px;        /* controls width */
  height:260px;           /* controls height */
  margin:auto;
}

.trade-chart canvas{
  width:100% !important;
  height:100% !important;
}

  .calendar-day {
  border-radius: 10px;
  padding: 10px;
  min-height: 95px;
  font-size: 13px;
}

.calendar-day.profit {
  background: #e9f9ee; /* green */
}

.calendar-day.loss {
  background: #fdecec; /* red */
}

.calendar-pnl.profit {
  color: #15803d;
  font-weight: bold;
}

.calendar-pnl.loss {
  color: #b91c1c;
  font-weight: bold;
}

.calendar-meta {
  margin-top: 2px;
}

.calendar-wl {
  margin-top: 6px;
  font-weight: bold;
  font-size: 12px;
}
/* ---- Summary UI ---- */
.summary-cards{
  display:flex;
  gap:16px;
  flex-wrap:wrap;
}

.summary-box{
  flex:1;
  min-width:200px;
  background:#f9fafb;
  border:1px solid #e5e7eb;
  border-radius:10px;
  padding:16px;
}

.summary-label{
  font-size:12px;
  text-transform:uppercase;
  color:#6b7280;
  margin-bottom:6px;
}

.summary-value{
  font-size:24px;
  font-weight:bold;
  line-height:1.2;
}

/* Color accents */
.profit-box .summary-value{ color:#16a34a; }
.loss-box .summary-value{ color:#dc2626; }
.net-box .summary-value{ color:#16a34a; }

/* ---- Drill-down table (final) ---- */

/* PnL */
.pnl{
  font-weight:bold;
}
.pnl.profit{
  color:#16a34a;
}
.pnl.loss{
  color:#dc2626;
}

/* Mistake tag */
.mistake{
  display:inline-block;
  padding:4px 10px;
  font-size:12px;
  border-radius:999px;
  background:#f1f5f9;
  color:#374151;
  border:1px solid #e5e7eb;
}

/* Mistake on loss */
.mistake.loss{
  background:#fee2e2;
  color:#b91c1c;
  border-color:#fecaca;
}
.mistake-card.bad:hover{
  background:#fee2e2;        /* light red */
  border-color:#fecaca;
  color:#991b1b;
}

/* GOOD / DISCIPLINED ‚Üí GREEN hover */
.mistake-card.good:hover{
  background:#dcfce7;        /* light green */
  border-color:#bbf7d0;
  color:#166534;
}
/* ---------- MISTAKE HEATMAP ---------- */
.heatmap{
  display:flex;
  align-items:flex-end;
  gap:18px;
  height:220px;              /* REQUIRED */
  padding-bottom:6px;
}

.bar-col{
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:flex-end;
  height:100%;
}

.bar{
  width:34px;
  border-radius:6px 6px 0 0;
}

/* Red intensity */
.bar.high{ background:#b91c1c; }
.bar.medium{ background:#dc2626; }
.bar.low{ background:#f87171; }

.bar-value{
  margin-top:6px;
  font-size:12px;
  font-weight:bold;
  color:#991b1b;
}

.bar-label{
  font-size:11px;
  color:#374151;
  text-align:center;
  white-space:nowrap;
}

  /* ---------- CHECKBOXES (COMPACT PREMIUM ‚Äì FINAL) ---------- */
.rules{
  display:grid;
  grid-template-columns:repeat(3, auto); /* dense grid */
  gap:6px 8px;
  margin-top:6px;
}

.rules label{
  display:flex;
  align-items:center;
  gap:6px;
  font-size:12px;
  background:#f9fafb;
  padding:4px 8px;          
  border-radius:6px;
  border:1px solid #e5e7eb;
  cursor:pointer;
  line-height:1.2;

  white-space:nowrap;       
  max-width:fit-content;    
}

.rules input{
  width:12px;              
  height:12px;
  margin:0;
}

.rules label:hover{
  background:#f1f5f9;
}

/* ===== MONTHLY PERFORMANCE (PURE CSS BARS) ===== */

.monthly-grid{
  display:flex;
  gap:5px;
  align-items:flex-end;
  min-height:260px;  
}

/* One month column */
.month{
  width:120px;
  text-align:center;
}

/* Bars container */
.bar-area{
  height:220px;
  display:flex;
  align-items:flex-end;
  justify-content:center;
  gap:10px;
}

/* IMPORTANT: enables % height bars */
.bar-wrap{
  height:100%;
  display:flex;
  flex-direction:column;
  justify-content:flex-end;
}

/* Bars */
.bar{
  width:20px;
  border-radius:6px 6px 0 0;
}

.bar.profit{ background:#16a34a; }  /* green */
.bar.loss{ background:#dc2626; }    /* red */

/* Values above bars */
.bar-value{
  font-size:12px;
  margin-bottom:6px;
  color:#111827;
}

/* Month text */
.month-label{
  margin-top:10px;
  font-size:13px;
  color:#374151;
}

.trade-count{
  font-size:12px;
  color:#6b7280;
  margin-top:px;
}

/* Net P&L (calendar-style emphasis) */
.net{
  margin-top:6px;
  font-size:16px;
  font-weight:bold;
}

.net.profit{ color:#16a34a; }
.net.loss{ color:#dc2626; }

.bar-col {
  position: relative;
  margin: 0 8px;   /* üëà creates space between bar groups */
}

.bar-value {
  margin-bottom: 6px;
  font-size: 12px;
  font-weight: 600;
  text-align: center;
  white-space: nowrap;
}

/* ===== Bar animation (Monthly / Heatmap / Any bars) ===== */
@keyframes growUp {
  from {
    transform: scaleY(0);
    opacity: 0;
  }
  to {
    transform: scaleY(1);
    opacity: 1;
  }
}

.bar {
  transform-origin: bottom;
  animation: growUp 0.6s ease-out forwards;
}

.bar {
  transition: transform 0.15s ease, filter 0.15s ease;
}

.bar:hover {
  transform: translateY(-4px);
  filter: brightness(1.05);
}

.calendar-header{
  justify-content:center;
  align-items:center;
  gap:16px;
  margin-bottom:12px;
}

.calendar-header button{
  border:none;
  background:#f1f5f9;
  border-radius:6px;
  padding:4px 10px;
  cursor:pointer;
  font-size:14px;
}

.calendar-header span{
  font-weight:bold;
  font-size:14px;
}

/* ---------- SELECT (Instrument Dropdown) ---------- */
.select-input {
  appearance: none;                 /* remove default arrow */
  -webkit-appearance: none;
  -moz-appearance: none;

  padding: 6px 34px 6px 10px;        /* space for arrow */
  font-size: 12px;
  border-radius: 6px;
  border: 1px solid #d1d5db;
  background-color: #fff;
  color: #111827;

  height: 30px;                     /* MATCH input height */
  width: 160px;

  background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 20 20' fill='gray' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M5.5 7.5l4.5 4.5 4.5-4.5'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 10px center;
  background-size: 14px;
}

/* Hover & focus polish */
.select-input:hover {
  background-color: #f9fafb;
}

.select-input:focus {
  outline: none;
  border-color: #2563eb;
  box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.3);
}

/* Header row */
.card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  cursor: pointer;
}

/* Chevron animation */
.chevron {
  font-size: 18px;
  transition: transform 0.2s ease;
}

/* Body collapse animation */
.card-body {
  overflow: hidden;
  transition: max-height 0.25s ease, opacity 0.2s ease;
}

/* Collapsed state */
.collapsible.collapsed .card-body {
  max-height: 0;
  opacity: 0;
}

/* Rotate arrow */
.collapsible.collapsed .chevron {
  transform: rotate(-90deg);
}

  .instrument-card {
  flex: 1;
  background: #f9fafb;
  border: 1px solid #e5e7eb;
  border-radius: 12px;
  padding: 16px;
}

.instrument-name {
  font-size: 13px;
  text-transform: uppercase;
  color: #6b7280;
  margin-bottom: 6px;
}

.instrument-pnl {
  font-size: 22px;
  font-weight: bold;
}

.instrument-pnl.profit {
  color: #16a34a;
}

.instrument-pnl.loss {
  color: #dc2626;
}

.instrument-trades {
  font-size: 13px;
  color: #374151;
  margin-top: 6px;
}

.instrument-wl {
  font-size: 12px;
  margin-top: 4px;
  color: #6b7280;
}

  /* ===== Make Instrument card single-line ===== */

.instrument-card {
  display: flex;
  align-items: center;
  gap: 14px;
}

.instrument-card > div {
  margin: 0 !important;
}

/* Net PnL bigger */
.instrument-pnl {
  font-weight: bold;
  font-size: 18px;
}

/* Small meta text */
.instrument-trades,
.instrument-wl {
  font-size: 12px;
  color: #6b7280;
}

/* Optional separator look */
.instrument-trades::before,
.instrument-wl::before {
  content: "‚Ä¢";
  margin-right: 6px;
}

.instrument-wl .win {
  color: #16a34a; /* green */
  font-weight: 600;
}

.instrument-wl .loss {
  color: #dc2626; /* red */
  font-weight: 600;
}

</style>
</head>

<body>
<div class="container">

<!-- ADD TRADE + PIE -->
<div class="card">
<h3>üìù Add Trade</h3>

<div class="trade-layout">

  <!-- LEFT 50% -->
  <div class="trade-form">

    <div class="input-row">
      <div class="input-group">
        <label>Date</label>
        <input type="date" id="date" class="date-input">
      </div>

      <div class="input-group">
        <label>PnL</label>
        <input type="number" id="pnl" class="pnl-input" placeholder="+ / -">
      </div>
    </div>

 <div class="input-group">
  <label>Instrument</label>
  <select id="instrument" class="select-input">
    <option value="NIFTY">NIFTY</option>
    <option value="SENSEX">SENSEX</option>
    <option value="BROKERAGE">BROKERAGE</option>
  </select>
</div>



    <label style="margin-top:10px">Mistakes</label>
  <div class="rules"> <label class="mistake-card bad">   <input type="checkbox" value="No Stop Loss"> No SL </label> 
   <label class="mistake-card bad">   <input type="checkbox" value="Free Channel with SL"> Free SL </label>
   <label class="mistake-card bad">  <input type="checkbox" value="FOMO Entry"> FOMO </label>
   <label class="mistake-card bad">   <input type="checkbox" value="Target 2 with SL"> T2 SL </label>
   <label class="mistake-card good"> <input type="checkbox" value="Target 1 Hit"> T1 Hit </label>
   <label class="mistake-card good"> <input type="checkbox" value="Free Channel Target Hit"> Free T1 </label>
   <label class="mistake-card bad"> <input type="checkbox" value="Stop Loss Hit"> SL Hit </label>
   <label class="mistake-card neutral"> <input type="checkbox" value="BROKERAGE"> Brokerage </label>
    </div>

    <div style="margin-top:12px">
      <button class="save" onclick="saveTrade()">Save</button>
      <button class="export" onclick="exportCSV()">Export</button>
    </div>

  </div>

  <!-- RIGHT 50% -->
  <div class="trade-chart">
  <div style="display:flex; gap:24px; align-items:flex-end">

    <!-- PIE -->
    <div>
      <h3>Profit & Loss Distribution</h3>
      <div class="pie-wrapper">
        <canvas id="lossPie"></canvas>
      </div>
    </div>

    <!-- HEATMAP -->
    <div>
      <h3>Mistake Impact (‚Çπ)</h3>
      <div class="heatmap" id="mistakeHeatmap"></div>
    </div>

  </div>
</div>


</div>
</div>

<!-- SUMMARY -->
<div class="card collapsible">
  <div class="card-header" onclick="toggleSection(this)">
    <h3>üßæ Summary</h3>
    <span class="chevron">‚ñæ</span>
  </div>

  <div class="card-body">
    <div class="summary-cards">
      <div class="summary-box profit-box">
        <div class="summary-label">Total Profit</div>
        <div class="summary-value" id="profit">‚Çπ0</div>
      </div>

      <div class="summary-box loss-box">
        <div class="summary-label">Total Loss</div>
        <div class="summary-value" id="loss">‚Çπ0</div>
      </div>

      <div class="summary-box net-box">
        <div class="summary-label">Net P&amp;L</div>
        <div class="summary-value" id="net">‚Çπ0</div>
      </div>
    </div>
  </div>
</div>

<!-- MONTHLY PERFORMANCE -->
<div class="card collapsible collapsed">
  <div class="card-header" onclick="toggleSection(this)">
    <h3>üìä Monthly Performance</h3>
    <span class="chevron">‚ñæ</span>
  </div>

  <div class="card-body">
    <div id="monthlyGrid" class="monthly-grid"></div>
  </div>
</div>

<div class="card collapsible collapsed">
  <div class="card-header" onclick="toggleSection(this)">
    <h3>üìà Instrument Performance</h3>
    <span class="chevron">‚ñæ</span>
  </div>

  <div class="card-body">
    <div id="instrumentStats" style="display:flex; gap:24px;"></div>
  </div>
</div>

<!-- CALENDAR -->
<div class="card">
<h3>üìÖ Calendar</h3>
<div class="calendar-header">
  <button onclick="changeMonth(-1)">‚óÄ</button>
  <span id="calendarTitle"></span>
  <button onclick="changeMonth(1)">‚ñ∂</button>
</div>

<div class="calendar" id="calendar"></div>
</div>

<!-- DRILL -->
<div class="card hidden" id="drill">
<h3 id="drillTitle"></h3>
<table>
<thead>
<tr><th class="pnl-col">PnL</th><th>Mistakes</th></tr>
</thead>
<tbody id="drillBody"></tbody>
</table>
</div>

</div>

<script>

let currentMonth = new Date().getMonth();
let currentYear  = new Date().getFullYear();

let db, lossChart;
const mistakeColorMap = {
  "No Stop Loss": "#dc2626",
  "Target 2 with SL": "#b91c1c",
  "FOMO Entry": "#f59e0b",
  "Free Channel with SL": "#fb923c",
  "Free Channel Target Hit": "#ea580c",
  "Stop Loss Hit": "#60a5fa",
  "Target 1 Hit": "#22c55e"
};

/* DB */
const req=indexedDB.open("TradeJournalDB",1);
req.onupgradeneeded=e=>{
  e.target.result.createObjectStore("trades",{keyPath:"id",autoIncrement:true});
};
req.onsuccess=e=>{
  db=e.target.result;
  loadAll();
};

/* SAVE */
function saveTrade() {
  const dateValue = document.getElementById("date").value;
  const pnlValue  = Number(document.getElementById("pnl").value);
  const instrumentValue = document.getElementById("instrument").value;

  if (!dateValue || pnlValue === 0) {
    alert("Date & PnL required");
    return;
  }

  // üîí HARD COLLECTION (no assumptions)
  const ruleNodes = document.querySelectorAll(".rules input[type=checkbox]");
  const rules = [];

  ruleNodes.forEach(cb => {
    if (cb.checked) {
      rules.push(cb.value);
    }
  });

const isBrokerage = rules.includes("BROKERAGE");

  const trade = {
    date: dateValue,
    pnl: pnlValue,
    rules: rules,
   isBrokerage,
   instrument: instrumentValue 
  };

  console.log("‚úÖ SAVED TRADE:", trade);

  const tx = db.transaction("trades", "readwrite");
  tx.objectStore("trades").add(trade);

  tx.oncomplete = () => {
    clearForm();
    loadAll();
  };
}

/* LOAD */
function loadAll(){
  db.transaction("trades","readonly")
    .objectStore("trades")
    .getAll()
    .onsuccess = e => {

      const trades = e.target.result;   // ‚≠ê ADD THIS LINE

      updateSummary(trades);
      buildMonthlyPerformance(trades);
      buildCalendar(trades);
      buildLossPie(trades);
      buildMistakeHeatmap(trades);
      buildInstrumentPerformance(trades);
    };
}

/* SUMMARY */
function updateSummary(t){
  let p = 0, l = 0;

  t.forEach(x => {
    if (x.pnl > 0) p += x.pnl;
    if (x.pnl < 0) l += Math.abs(x.pnl);
  });

  const netValue = p - l;

  profit.innerText = "‚Çπ" + p;
  loss.innerText   = "‚Çπ" + l;
  net.innerText    = (netValue >= 0 ? "‚Çπ" : "-‚Çπ") + Math.abs(netValue);

  // ‚úÖ THIS is the only new logic
  net.style.color = netValue >= 0 ? "#16a34a" : "#dc2626";
}
/* CALENDAR */
function buildCalendar(t){
  calendar.innerHTML = "";

 const y = currentYear;
 const m = currentMonth;

document.getElementById("calendarTitle").innerText =
  new Date(y, m).toLocaleString("default", {
    month: "long",
    year: "numeric"
  });


  const first = new Date(y, m, 1).getDay() || 7;
  const days  = new Date(y, m + 1, 0).getDate();

  const map = {};
  t.forEach(x => {
    map[x.date] = (map[x.date] || []).concat(x);
  });

  ["Mon","Tue","Wed","Thu","Fri","Sat","Sun"]
    .forEach(h => calendar.innerHTML += `<div class="day-header">${h}</div>`);

  for (let i = 1; i < first; i++) {
    calendar.innerHTML += `<div></div>`;
  }

  for (let i = 1; i <= days; i++) {
    const ds = `${y}-${String(m+1).padStart(2,"0")}-${String(i).padStart(2,"0")}`;
    const list = map[ds] || [];

    if (list.length === 0) {
      calendar.innerHTML += `
        <div class="day neutral">
          <div class="day-date">${i}</div>
          No Trades
        </div>`;
      continue;
    }

    let pnl = 0, wins = 0, losses = 0;

    list.forEach(x => {
      pnl += x.pnl;
      if (x.isBrokerage) return; 
      if (x.pnl > 0) wins++;
      if (x.pnl < 0) losses++;
    });

    const colorClass = pnl >= 0 ? "green" : "red";

    calendar.innerHTML += `
      <div class="day ${colorClass}" onclick="openDay('${ds}')">
        <div class="day-date">${i}</div>

        <div class="day-pnl">‚Çπ${pnl}</div>

        <div class="day-details">
          ${list.filter(t => !t.isBrokerage).length} trades<br>
          ${wins}W / ${losses}L
        </div>
      </div>`;
  }
}

function buildMonthlyPerformance(trades){
  const grid = document.getElementById("monthlyGrid");

  if (!grid) {
    console.warn("‚ùå monthlyGrid not found");
    return;
  }

  if (!Array.isArray(trades) || trades.length === 0) {
    console.warn("‚ùå No trades for monthly chart");
    grid.innerHTML = "<div style='color:#6b7280'>No data</div>";
    return;
  }

  grid.innerHTML = "";

  const monthMap = {};

  trades.forEach(t => {
    if (!t.date || typeof t.pnl !== "number") return;

    const d = new Date(t.date);
    const key = `${d.getFullYear()}-${d.getMonth()}`;

    if (!monthMap[key]) {
      monthMap[key] = {
        label: d.toLocaleString("default",{month:"short",year:"numeric"}),
        trades: 0,
        profit: 0,
        loss: 0
      };
    }

    if (!t.isBrokerage) {
    monthMap[key].trades++;   
    }

    if (t.pnl > 0) monthMap[key].profit += t.pnl;
    if (t.pnl < 0) monthMap[key].loss += Math.abs(t.pnl);
  });

  const months = Object.values(monthMap);

  if (!months.length) {
    grid.innerHTML = "<div style='color:#6b7280'>No monthly data</div>";
    return;
  }

  const maxValue = Math.max(
    ...months.map(m => Math.max(m.profit, m.loss, 1))
  );

  months.forEach(m => {
    const net = m.profit - m.loss;

    const profitHeight = (m.profit / maxValue) * 100;
    const lossHeight   = (m.loss / maxValue) * 100;

    grid.innerHTML += `
      <div class="month">
        <div class="bar-area">

          <div class="bar-wrap">
            ${m.profit ? `<div class="bar-value">‚Çπ${m.profit.toLocaleString()}</div>` : ``}
            <div class="bar profit" style="height:${profitHeight}%"></div>
          </div>

          <div class="bar-wrap">
            ${m.loss ? `<div class="bar-value">‚Çπ${m.loss.toLocaleString()}</div>` : ``}
            <div class="bar loss" style="height:${lossHeight}%"></div>
          </div>

        </div>

        <div class="month-label">${m.label}</div>
        <div class="trade-count">${m.trades} trades</div>
        <div class="net ${net >= 0 ? "profit" : "loss"}">
          ${net >= 0 ? "‚Çπ" : "-‚Çπ"}${Math.abs(net).toLocaleString()}
        </div>
      </div>
    `;
  });

  console.log("‚úÖ Monthly chart rendered");
}


/* DRILL */
function openDay(selectedDate) {
  const drill = document.getElementById("drill");
  const drillTitle = document.getElementById("drillTitle");
  const drillBody = document.getElementById("drillBody");

  drill.classList.remove("hidden");
  drillTitle.innerText = "Trades on " + selectedDate;
  drillBody.innerHTML = "";

  const tx = db.transaction("trades", "readonly");
  const store = tx.objectStore("trades");
  const req = store.getAll();

  req.onsuccess = () => {
    req.result
      .filter(t => t.date === selectedDate)
      .forEach(t => {
        drillBody.innerHTML += `
      <tr>
        <td class="pnl-col pnl ${t.pnl < 0 ? 'loss' : 'profit'}">
          ${t.pnl >= 0 ? "‚Çπ" + t.pnl : "-‚Çπ" + Math.abs(t.pnl)}
      </td>
      <td>
        ${
          Array.isArray(t.rules) && t.rules.length
            ? `<span class="mistake ${t.pnl < 0 ? 'loss' : ''}">
               ${t.rules.join(", ")}
             </span>`
          : "-"
        }
    </td>
  </tr>
`;
      });
  };
}

/* PIE */
function buildLossPie(trades) {
  const impactByMistake = {};

  trades.forEach(t => {
    if (t.isBrokerage) return;
    if (!t.rules || t.rules.length === 0) return;

    const impact = Math.abs(t.pnl); // profit + loss

    t.rules.forEach(rule => {
      impactByMistake[rule] =
        (impactByMistake[rule] || 0) + impact;
    });
  });

  // Destroy old chart (CRITICAL)
  if (window.lossChart) {
    window.lossChart.destroy();
    window.lossChart = null;
  }

  const labels = Object.keys(impactByMistake);
  const data = Object.values(impactByMistake);

  if (labels.length === 0) return;

  // ‚úÖ Behavior-based color mapping (order safe)
  const colorMap = {
  /* ‚ùå BAD / HIGH RISK */
  "No Stop Loss": "#dc2626",            // deep red ‚Äì capital protection failure
  "Target 2 with SL": "#b91c1c",         // dark red ‚Äì greed (should exit at T1)
  "FOMO Entry": "#f59e0b",               // amber ‚Äì emotional entry
  /* ‚ö†Ô∏è NOT IDEAL / EXTERNAL */
  "Free Channel with SL": "#fb923c",     // orange ‚Äì external dependency (some control)
  "Free Channel Target Hit": "#ea580c",  // orange ‚Äì profit but not own setup
  /* üü¶ DISCIPLINED LOSS */
  "Stop Loss Hit": "#60a5fa",            // blue ‚Äì rule-based loss
  /* ‚úÖ GOOD / DISCIPLINED */
  "Target 1 Hit": "#22c55e"             // green ‚Äì correct execution
  };


  const colors = labels.map(l => colorMap[l] || "#94a3b8");

  const ctx = document.getElementById("lossPie").getContext("2d");

  window.lossChart = new Chart(ctx, {
    type: "pie",
    data: {
      labels,
      datasets: [{
        data,
        backgroundColor: labels.map(l => mistakeColorMap[l] || "#94a3b8")
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          display: false
        },
        tooltip: {
          callbacks: {
            label: ctx => {
              const total = ctx.dataset.data.reduce((a,b)=>a+b,0);
              const pct = ((ctx.raw / total) * 100).toFixed(1);
              return `${ctx.label} ‚Äî ‚Çπ${ctx.raw} (${pct}%)`;
            }
          }
        }
      }
    }
  });
}

function buildMistakeHeatmap(trades) {
  const container = document.getElementById("mistakeHeatmap");
  if (!container) return;

  container.innerHTML = "";

  const impactByMistake = {};

  trades.forEach(t => {
    if (t.isBrokerage) return;
    if (!t.rules || !t.rules.length) return;

    const impact = Math.abs(t.pnl);

    t.rules.forEach(rule => {
      impactByMistake[rule] =
        (impactByMistake[rule] || 0) + impact;
    });
  });

  const entries = Object.entries(impactByMistake)
    .sort((a,b) => b[1] - a[1])
    .slice(0,5);

  if (!entries.length) return;

  const max = entries[0][1];

  entries.forEach(([mistake, value]) => {
    const height = (value / max) * 100;
    const color = mistakeColorMap[mistake] || "#94a3b8";
    const short = mistake
      .replace("No Stop Loss","NO SL")
      .replace("FOMO Entry","FOMO")
      .replace("Target 2 with SL","T2 SL")
      .replace("Free Channel with SL","Free SL")
      .replace("Free Channel Target Hit","Free T1")
      .replace("Stop Loss Hit","SL Hit")
      .replace("Target 1 Hit","T1 Hit");

    container.innerHTML += `
      <div class="bar-col">
        <div class="bar" style="height:${height}%; background:${color}"></div>
        <div class="bar-value">‚Çπ${Math.round(value)}</div>
        <div class="bar-label">${short}</div>
      </div>
    `;
  });
}


/* EXPORT */
function exportCSV(){
  db.transaction("trades","readonly").objectStore("trades").getAll().onsuccess=e=>{
    let csv="Date,PnL,Mistakes\n";
    e.target.result.forEach(x=>csv+=`${x.date},${x.pnl},"${x.rules.join(", ")}"\n`);
    const a=document.createElement("a");
    a.href=URL.createObjectURL(new Blob([csv]));
    a.download="trading-journal.csv";
    a.click();
  };
}

/* HELPERS */
const pnlEl=()=>document.getElementById("pnl");
function clearForm(){
  date.value=""; pnl.value="";
  document.querySelectorAll("input[type=checkbox]").forEach(c=>c.checked=false);
}

function changeMonth(delta){
  currentMonth += delta;

  if (currentMonth < 0) {
    currentMonth = 11;
    currentYear--;
  }

  if (currentMonth > 11) {
    currentMonth = 0;
    currentYear++;
  }

  loadAll();  
}

function buildInstrumentPerformance(trades) {
  const container = document.getElementById("instrumentStats");
  if (!container) return;

  container.innerHTML = "";

  const instruments = {
    NIFTY: {
      pnl: 0,
      trades: 0,
      wins: 0,
      losses: 0
    },
    SENSEX: {
      pnl: 0,
      trades: 0,
      wins: 0,
      losses: 0
    }
  };

  trades.forEach(t => {
    // ‚ùå Ignore brokerage & invalid data
    if (!t.instrument) return;
    if (t.instrument === "BROKERAGE") return;
    if (!instruments[t.instrument]) return;

    instruments[t.instrument].trades += 1;
    instruments[t.instrument].pnl += t.pnl;

    if (t.pnl > 0) instruments[t.instrument].wins += 1;
    if (t.pnl < 0) instruments[t.instrument].losses += 1;
  });

  Object.entries(instruments).forEach(([name, data]) => {
    if (data.trades === 0) return;

    const pnlClass = data.pnl >= 0 ? "profit" : "loss";
    const sign = data.pnl >= 0 ? "‚Çπ" : "-‚Çπ";

    container.innerHTML += `
      <div class="instrument-card ${pnlClass}">
        <div class="instrument-name">${name}</div>

        <div class="instrument-pnl ${pnlClass}">
          ${sign}${Math.abs(data.pnl).toLocaleString()}
        </div>

        <div class="instrument-trades">
          ${data.trades} trades
        </div>

        <div class="instrument-wl">
          <span class="win">${data.wins}W</span> /
          <span class="loss">${data.losses}L</span>
        </div>
      </div>
    `;
  });
}

function toggleSection(header){
  const card = header.closest(".collapsible");
  card.classList.toggle("collapsed");
}

if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("sw.js");
}
</script>

</body>
</html>








